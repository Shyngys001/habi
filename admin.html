<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>SyBaga — админ-панель</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary:#ff1947;
      --primary-dark:#960505;
      --primary-bg:#f5f3ff;
      --secondary:#10b981;
      --secondary-dark:#059669;
      --accent:#f59e0b;
      --danger:#ef4444;
      --danger-dark:#dc2626;
      --text:#1f2937;
      --text-light:#6b7280;
      --text-lighter:#9ca3af;
      --bg:#f9fafb;
      --bg-card:#ffffff;
      --border:#e5e7eb;
      --border-light:#f3f4f6;
      --shadow:0 1px 3px 0 rgba(0,0,0,.1),0 1px 2px 0 rgba(0,0,0,.06);
      --shadow-lg:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -2px rgba(0,0,0,.05);
      --radius:12px;
      --radius-lg:16px;
      --radius-xl:20px;
    }

    *{box-sizing:border-box;margin:0;padding:0;}

    body{
      min-height:100vh;
      font-family:'Inter',system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:var(--bg);
      color:var(--text);
      line-height:1.5;
    }

    .app-container{
      max-width:1200px;
      margin:0 auto;
      padding:0 16px 40px;
    }

    .app-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:20px 0;
      margin-bottom:16px;
    }

    .logo{
      display:flex;
      align-items:center;
      gap:12px;
      font-weight:800;
      font-size:24px;
      color:var(--primary);
    }
    .logo-icon{
      background:var(--primary);
      color:white;
      width:40px;height:40px;
      border-radius:10px;
      display:flex;align-items:center;justify-content:center;
    }
    .link-client{
      font-size:13px;
      color:var(--text-light);
    }
    .link-client a{color:var(--text-light);text-decoration:underline;}

    .card{
      background:var(--bg-card);
      border-radius:var(--radius-lg);
      padding:24px;
      box-shadow:var(--shadow);
      border:1px solid var(--border);
      margin-bottom:20px;
    }
    .card-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:20px;
    }
    .card-title{font-size:20px;font-weight:700;}
    .card-subtitle{font-size:14px;color:var(--text-light);margin-top:4px;}

    .form-group{margin-bottom:16px;}
    .form-label{display:block;font-size:14px;font-weight:500;margin-bottom:6px;}
    .form-input{
      width:100%;padding:12px 16px;
      border-radius:var(--radius);
      border:1px solid var(--border);
      font-size:15px;
      transition:all .2s;
    }
    .form-input:focus{
      outline:none;
      border-color:var(--primary);
      box-shadow:0 0 0 3px rgba(124,58,237,.1);
    }

    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:10px 18px;
      border-radius:var(--radius);
      font-size:14px;font-weight:500;
      cursor:pointer;
      transition:all .2s;
      border:none;
      gap:8px;
    }
    .btn[disabled]{opacity:.6;cursor:default;}
    .btn-primary{background:var(--primary);color:white;}
    .btn-primary:hover:not([disabled]){background:var(--primary-dark);}
    .btn-secondary{background:var(--secondary);color:white;}
    .btn-secondary:hover:not([disabled]){background:var(--secondary-dark);}
    .btn-outline{background:transparent;color:var(--text);border:1px solid var(--border);}
    .btn-outline:hover:not([disabled]){background:var(--bg);}
    .btn-danger{background:var(--danger);color:white;}
    .btn-danger:hover:not([disabled]){background:var(--danger-dark);}
    .btn-sm{padding:8px 12px;font-size:13px;}

    .toast{
      margin-top:12px;
      padding:10px 14px;
      border-radius:var(--radius);
      font-size:14px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .toast-success{
      background:#ecfdf5;
      color:var(--secondary-dark);
      border:1px solid #a7f3d0;
    }
    .toast-error{
      background:#fef2f2;
      color:#b91c1c;
      border:1px solid #fecaca;
    }

    .status-badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 12px;
      border-radius:20px;
      font-size:13px;
      font-weight:500;
    }
    .status-warning{background:#fffbeb;color:var(--accent);}

    .admin-layout{
      display:grid;
      grid-template-columns:260px 1fr;
      gap:24px;
    }
    @media(max-width:900px){
      .admin-layout{grid-template-columns:1fr;}
    }

    .admin-sidebar{
      background:var(--bg-card);
      border-radius:var(--radius-lg);
      padding:16px 0;
      box-shadow:var(--shadow);
      border:1px solid var(--border);
      height:fit-content;
    }
    .sidebar-section-title{
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:var(--text-lighter);
      margin-bottom:8px;
      padding:0 20px;
      font-weight:600;
    }
    .nav-list{display:flex;flex-direction:column;}
    .nav-item{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 20px;
      font-size:14px;
      cursor:pointer;
      transition:all .2s;
    }
    .nav-item span i{margin-right:6px;}
    .nav-item:hover{background:var(--bg);}
    .nav-item.active{
      background:var(--primary-bg);
      color:var(--primary);
      border-left:3px solid var(--primary);
    }
    .nav-badge{
      background:var(--bg);
      padding:2px 6px;
      border-radius:999px;
      font-size:11px;
      color:var(--text-light);
    }
    .nav-item.active .nav-badge{background:var(--primary);color:white;}

    .kpi-grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(200px,1fr));
      gap:16px;
    }
    .kpi-card{
      background:var(--bg-card);
      border-radius:var(--radius);
      padding:18px;
      border:1px solid var(--border);
    }
        /* Top-4 guests card */
        .top4-card {
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .top4-header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:4px;
    }
    .top4-title {
      font-size:14px;
      font-weight:600;
    }
    .top4-sub {
      font-size:12px;
      color:var(--text-light);
    }
    .top4-list {
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-top:4px;
    }
    .top4-item {
      display:grid;
      grid-template-columns:32px minmax(0,1fr) auto;
      align-items:center;
      gap:10px;
      padding:8px 10px;
      border-radius:10px;
      background:var(--bg);
    }
    .top4-rank {
      width:26px;
      height:26px;
      border-radius:999px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:13px;
      font-weight:600;
      background:var(--primary-bg);
      color:var(--primary);
    }
    .top4-main {
      min-width:0;
    }
    .top4-name {
      font-size:13px;
      font-weight:600;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .top4-phone {
      font-size:12px;
      color:var(--text-light);
    }
    .top4-right {
      text-align:right;
      font-size:12px;
    }
    .top4-sum {
      font-weight:600;
    }
    .top4-tier-badge {
      display:inline-flex;
      align-items:center;
      gap:4px;
      padding:2px 8px;
      border-radius:999px;
      font-size:11px;
      margin-top:2px;
    }
    .top4-tier-diamond {
      background:#ecfeff;
      color:#0e7490;
    }
    .top4-tier-gold {
      background:#fef3c7;
      color:#b45309;
    }
    .top4-tier-silver {
      background:#e5e7eb;
      color:#374151;
    }
    .top4-tier-bronze {
      background:#fef2f2;
      color:#b91c1c;
    }
    .kpi-icon{
      width:36px;height:36px;
      border-radius:10px;
      display:flex;align-items:center;justify-content:center;
      font-size:18px;
      margin-bottom:10px;
    }
    .kpi-icon.primary{background:var(--primary-bg);color:var(--primary);}
    .kpi-icon.success{background:#ecfdf5;color:var(--secondary);}
    .kpi-icon.warning{background:#fffbeb;color:var(--accent);}
    .kpi-label{font-size:13px;color:var(--text-light);}
    .kpi-value{font-size:22px;font-weight:700;}

    .section-title{font-size:16px;font-weight:600;margin-bottom:8px;}
    .section-desc{font-size:13px;color:var(--text-light);margin-bottom:12px;}

    .grid-2{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:20px;
    }
    @media(max-width:900px){
      .grid-2{grid-template-columns:1fr;}
    }

    .divider{height:1px;background:var(--border);margin:20px 0;}

    .table-container{
      overflow-x:auto;
      border-radius:var(--radius);
      border:1px solid var(--border);
    }
    table{width:100%;border-collapse:collapse;font-size:14px;}
    th,td{padding:10px 14px;text-align:left;border-bottom:1px solid var(--border);}
    th{background:var(--bg);font-weight:600;font-size:13px;color:var(--text-light);}
    tr:last-child td{border-bottom:none;}
    tr:hover{background:var(--bg);}

    .clickable-row{
      padding:8px 10px;
      border-radius:10px;
      border:1px solid var(--border);
      margin-bottom:6px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      cursor:pointer;
      font-size:13px;
    }
    .clickable-row:hover{background:var(--bg);}
    .clickable-row.active{
      border-color:var(--primary);
      background:var(--primary-bg);
      color:var(--primary);
    }
    .pill{
      display:inline-flex;
      padding:3px 8px;
      border-radius:999px;
      font-size:11px;
      background:var(--bg);
      color:var(--text-light);
    }

    .gift-grid{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(240px,1fr));
      gap:16px;
    }
    .gift-card{
      border-radius:var(--radius-lg);
      border:1px solid var(--border);
      overflow:hidden;
      background:var(--bg-card);
      position:relative;
      transition:all .3s;
    }
    .gift-card:hover{transform:translateY(-4px);box-shadow:var(--shadow-lg);}
    .gift-image{
      width:100%;height:120px;
      object-fit:contain;
    }
    .gift-content{padding:14px;}
    .gift-title{font-size:15px;font-weight:600;margin-bottom:4px;}
    .gift-price{font-size:14px;color:var(--text-light);margin-bottom:2px;}
    .gift-left{font-size:12px;color:var(--text-lighter);margin-bottom:6px;}
    .gift-out{
      position:absolute;
      top:10px;right:10px;
      padding:4px 10px;
      border-radius:999px;
      background:#fee2e2;
      color:#b91c1c;
      font-size:11px;
      font-weight:600;
    }

    /* Карточки клиента (админ) */
    .user-info-grid {
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(200px,1fr));
      gap:16px;
    }
    .info-card {
      background:var(--bg);
      border-radius:var(--radius);
      padding:16px;
      border:1px solid var(--border-light);
    }
    .info-label {
      font-size:13px;
      color:var(--text-light);
      margin-bottom:4px;
    }
    .info-value {
      font-size:18px;
      font-weight:700;
    }

    /* Доступные подарки (в разделе выдачи) */
    .redeem-gifts-list{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:10px;
    }
    .redeem-gift-card{
      border-radius:18px;
      border:1px solid var(--border);
      background:var(--bg-card);
      padding:12px 14px;
      display:grid;
      grid-template-columns:110px 1fr;
      gap:10px;
      align-items:center;
      box-shadow:var(--shadow);
      font-size:13px;
    }
    .redeem-gift-card img{
      width:100%;
      height:110px;
      border-radius:14px;
      object-fit:cover;
      background:#e5e7eb;
    }
    .redeem-gift-main{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .redeem-gift-title{
      font-size:15px;
      font-weight:600;
    }
    .redeem-gift-price{
      font-size:13px;
      color:var(--text-light);
    }
    .redeem-gift-balance{
      font-size:12px;
      color:var(--text-light);
    }
    .redeem-gift-note{
      font-size:12px;
      margin-top:2px;
    }
    .redeem-gift-card.available{
      border-color:#bbf7d0;
      background:#f0fdf4;
    }
    .redeem-gift-card.locked{
      opacity:.8;
    }
    .redeem-gift-note-ok{color:#16a34a;}
    .redeem-gift-note-bad{color:#b91c1c;}
    .redeem-gift-btn{
      margin-top:6px;
      align-self:flex-start;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <header class="app-header">
      <div class="logo">
        <div class="logo-icon"><i class="fas fa-gift"></i></div>
        <span>SyBaga · Админ-панель</span>
      </div>
      <div class="link-client">
        <a href="index.html">Перейти в кабинет гостя</a>
      </div>
    </header>

    <!-- Блок авторизации администратора -->
    <section class="card" id="admin-login-card">
      <div class="card-header">
        <div>
          <h2 class="card-title">Вход для сотрудников</h2>
          <p class="card-subtitle">Используйте служебный логин и пароль.</p>
        </div>
        <div class="status-badge status-warning">
          <i class="fas fa-lock"></i> Доступ закрыт
        </div>
      </div>
      <div class="grid-2">
        <div class="form-group">
          <label class="form-label">Логин</label>
          <input type="text" class="form-input" id="adm-login">
        </div>
        <div class="form-group">
          <label class="form-label">Пароль</label>
          <input type="password" class="form-input" id="adm-pass">
        </div>
      </div>
      <button class="btn btn-primary" id="btn-adm-login">
        <i class="fas fa-key"></i> Войти в админ-панель
      </button>
      <div id="a-toast" class="toast"></div>
    </section>

    <!-- Основная структура админки -->
    <section id="admin-layout" style="display:none;">
      <div class="admin-layout">
        <!-- Сайдбар -->
        <aside class="admin-sidebar">
          <div class="sidebar-section-title">Навигация</div>
          <nav class="nav-list">
            <div class="nav-item active" data-page="admin-dashboard">
              <span><i class="fas fa-gauge"></i>Дашборд</span>
              <span class="nav-badge">Обзор</span>
            </div>
            <div class="nav-item" data-page="admin-clients">
              <span><i class="fas fa-users"></i>Клиенты</span>
              <span class="nav-badge">База</span>
            </div>
            <div class="nav-item" data-page="admin-gifts">
              <span><i class="fas fa-gift"></i>Подарки</span>
              <span class="nav-badge">Каталог</span>
            </div>
            <div class="nav-item" data-page="admin-analytics">
              <span><i class="fas fa-chart-bar"></i>Аналитика</span>
              <span class="nav-badge">Отчёты</span>
            </div>
          </nav>
        </aside>

        <!-- Контент -->
        <main>
          <!-- 1. Дашборд -->
          <section class="card admin-subpage" id="admin-dashboard" style="display:block;">
            <div class="card-header">
              <div>
                <h2 class="card-title">Дашборд</h2>
                <p class="card-subtitle">Краткий обзор программы лояльности.</p>
              </div>
              <button class="btn btn-outline" id="btn-refresh-dashboard">
                <i class="fas fa-rotate-right"></i> Обновить дашборд
              </button>
            </div>

            <div class="kpi-grid" id="dash-kpis"></div>

            <div class="divider"></div>

            <div class="grid-2">
              <div>
                <h3 class="section-title">Работа с клиентами</h3>
                <p class="section-desc">Добавление новых гостей и регистрация чеков.</p>
                <button class="btn btn-primary" id="btn-go-clients">
                  <i class="fas fa-users"></i> Перейти в раздел «Клиенты»
                </button>
              </div>
              <div>
                <h3 class="section-title">Подарки и аналитика</h3>
                <p class="section-desc">Настройка каталога подарков и просмотр статистики.</p>
                <div style="display:flex;flex-wrap:wrap;gap:8px;">
                  <button class="btn btn-outline" id="btn-go-gifts">
                    <i class="fas fa-gift"></i> Раздел «Подарки»
                  </button>
                  <button class="btn btn-outline" id="btn-go-analytics">
                    <i class="fas fa-chart-bar"></i> Раздел «Аналитика»
                  </button>
                </div>
              </div>
            </div>
          </section>

          <!-- 2. Клиенты -->
          <section class="card admin-subpage" id="admin-clients" style="display:none;">
            <div class="card-header">
              <div>
                <h2 class="card-title">Клиенты</h2>
                <p class="card-subtitle">Создание клиентов, поиск и работа с чеками.</p>
              </div>
            </div>

            <!-- Блок 1: Создание клиента / Поиск -->
            <div class="grid-2">
              <!-- 1.1 Новый клиент -->
              <div>
                <h3 class="section-title">1. Новый клиент</h3>
                <p class="section-desc">Заполните данные гостя, чтобы начать копить бонусы.</p>
                <div class="form-group">
                  <label class="form-label">Имя гостя</label>
                  <input type="text" class="form-input" id="new-name">
                </div>
                <div class="form-group">
                  <label class="form-label">Телефон</label>
                  <input type="text" class="form-input" id="new-phone" placeholder="+7 777 000 00 00">
                </div>
                <button class="btn btn-primary" id="btn-add-user">
                  <i class="fas fa-user-plus"></i> Создать клиента
                </button>
              </div>

              <!-- 1.2 Поиск клиента -->
              <div>
                <h3 class="section-title">2. Поиск клиента</h3>
                <p class="section-desc">Введите имя или номер телефона и выберите клиента из списка.</p>
                <div class="form-group">
                  <label class="form-label">Имя или телефон</label>
                  <input type="text" class="form-input" id="users-q" placeholder="например, Айжан или +7777...">
                </div>
                <div id="users-list" style="max-height:280px;overflow:auto;"></div>
              </div>
            </div>

            <div class="divider"></div>

            <!-- Блок 2: Карточка клиента / чеки -->
            <div class="grid-2">
              <div>
                <h3 class="section-title">3. Чеки клиента</h3>
                <p class="section-desc">Добавьте сумму чека — бонусы начислятся автоматически.</p>

                <div class="form-group">
                  <label class="form-label">Тип чека</label>
                  <select class="form-input" id="bill-type">
                    <option value="normal">Обычный чек</option>
                    <option value="banquet">Банкет</option>
                  </select>
                  <p class="card-subtitle" style="margin-top:4px;">
                    Баллы за банкеты копятся отдельно и тратятся только на «банкетные» подарки.
                  </p>
                </div>

                <div class="form-group">
                  <label class="form-label">Сумма нового чека, ₸</label>
                  <div class="grid-2" style="gap:10px;">
                    <input type="number" class="form-input" id="bill-sum" placeholder="Например, 15000">
                    <button class="btn btn-primary" id="btn-add-bill">
                      <i class="fas fa-plus"></i> Добавить чек
                    </button>
                  </div>
                  <p class="card-subtitle" style="margin-top:4px;">
                    Телефон берётся из выбранного клиента в блоке «Поиск клиента».
                  </p>
                </div>
                <div>
                  <h3 class="section-title">4. Карточка клиента</h3>
                  <p class="section-desc">Информация по балансу и полученным подаркам.</p>
                  <div id="client-profile"></div>
                </div>
                <div id="bills-list" style="margin-top:12px;max-height:260px;overflow:auto;"></div>
              </div>
            </div>
          </section>

          <!-- 3. Подарки -->
          <section class="card admin-subpage" id="admin-gifts" style="display:none;">
            <div class="card-header">
              <div>
                <h2 class="card-title">Подарки</h2>
                <p class="card-subtitle">Настройка каталога и выдача подарков гостям.</p>
              </div>
            </div>

            <!-- Блок 1: Настройки подарка -->
            <div class="grid-2">
              <div  style="display: none;">
                <h3 class="section-title">1. Создание / редактирование подарка</h3>
                <p class="section-desc">Заполните данные подарка и сохраните его в каталоге.</p>
                <div class="form-group">
                  <label class="form-label">Название подарка</label>
                  <input type="text" class="form-input" id="g-name">
                </div>
                <div class="form-group">
                  <label class="form-label">Цена (кол-во бонусов)</label>
                  <input type="number" class="form-input" id="g-price" placeholder="Например, 3000">
                </div>
                <div class="form-group">
                  <label class="form-label">Фото (URL или data:image)</label>
                  <input type="text" class="form-input" id="g-photo" placeholder="https://... или data:image/...">
                </div>
                <div class="form-group">
                  <label class="form-label">Количество на складе</label>
                  <input type="number" class="form-input" id="g-left" placeholder="Например, 10">
                </div>
                <div class="form-group">
                  <label class="form-label">Тип бонусов</label>
                  <select class="form-input" id="g-bonus-type">
                    <option value="normal">Обычные баллы</option>
                    <option value="banquet">Баллы за банкеты</option>
                  </select>
                </div>
                <button class="btn btn-primary" id="btn-g-create">
                  <i class="fas fa-floppy-disk"></i> Сохранить подарок
                </button>
              </div>

              <!-- Блок 2: Выдача подарка -->
              <div>
                <h3 class="section-title">Выдача подарка клиенту</h3>
                <p class="section-desc">
                  После ввода телефона ниже появится список подарков, отсортированный: сначала те, которые можно выдать.
                </p>
                <div class="form-group">
                  <label class="form-label">Телефон клиента</label>
                  <input type="text" class="form-input" id="r-phone" placeholder="+7 777 000 00 00">
                  <p class="card-subtitle" style="margin-top:4px;">
                    У каждого подарка своя кнопка «Выдать этот подарок».
                  </p>
                </div>
                <h4 class="section-title" style="margin-top:4px;">Доступные подарки</h4>
                <div id="redeem-gifts-list" class="redeem-gifts-list"></div>
              </div>
            </div>

            <div class="divider"></div>

            <!-- Блок 3: Список всех подарков -->
            <h3 class="section-title">Каталог подарков</h3>
            <p class="section-desc">Список всех активных и неактивных подарков SyBaga.</p>
            <div id="gifts-admin" class="gift-grid"></div>
          </section>

          <!-- 4. Аналитика -->
          <section class="card admin-subpage" id="admin-analytics" style="display:none;">
            <div class="card-header">
              <div>
                <h2 class="card-title">Аналитика и отчёты</h2>
                <p class="card-subtitle">Статистика по сумме чеков и активности клиентов.</p>
              </div>
            </div>

            <!-- Блок 1: Кнопки -->
            <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:16px;">
              <button class="btn btn-primary" id="btn-analytics">
                <i class="fas fa-calculator"></i> Пересчитать аналитику
              </button>
              <button class="btn btn-outline" id="btn-export-users">
                <i class="fas fa-file-export"></i> Экспорт клиентов
              </button>
              <button class="btn btn-outline" id="btn-export-bills">
                <i class="fas fa-file-export"></i> Экспорт чеков
              </button>
              <button class="btn btn-outline" id="btn-export-redeem">
                <i class="fas fa-file-export"></i> Экспорт выданных подарков
              </button>
            </div>

            <!-- Блок 2: KPI -->
            <div class="kpi-grid" id="kpi"></div>

            <div class="divider"></div>

            <!-- Блок 3: Таблица по клиентам -->
            <h3 class="section-title">Детальная статистика по клиентам</h3>
            <p class="section-desc">Список гостей с суммой чеков, балансами и статусом (Diamond / Gold / Silver / Bronze).</p>
            <div id="analytics-table" class="table-container"></div>
          </section>
        </main>
      </div>
    </section>
  </div>

  <script>
    /* URL Apps Script */
    const API_BASE = 'https://script.google.com/macros/s/AKfycbxkyjMArpTcCEOLR73rkllZGIAFPxddb9k3VuVpCic4pSFKEoJHn4_95BKb96u2QY6PqA/exec';

    const $ = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);

    const el = (t,a={},c=[])=>{
      const n=document.createElement(t);
      for(const k in a){
        if(k==='class') n.className=a[k];
        else if(k==='html') n.innerHTML=a[k];
        else n.setAttribute(k,a[k]);
      }
      (Array.isArray(c)?c:[c]).filter(Boolean).forEach(x=>n.append(x));
      return n;
    };

    function normPhone(p){
      p = String(p || '').replace(/[^\d+]/g,'');
      if(p.startsWith('+7')) return p;
      if(p.startsWith('8') && p.length===11) return '+7'+p.slice(1);
      if(p.length===10) return '+7'+p;
      if(p.length===11 && p[0]==='7') return '+'+p;
      return p;
    }

    function normalizePhotoUrl(url) {
  if (!url) return '';
  
  url = String(url).trim();
  if (!url) return '';
  
  // 1) Если это data:image — возвращаем как есть
  if (url.startsWith('data:image')) return url;
  
  // 2) Убираем формулы Google Sheets
  if (url.startsWith('=IMAGE("')) {
    url = url.replace(/^=IMAGE\("(.*?)"\)$/i, '$1');
    url = url.replace(/^["']+|["']+$/g, ''); // Убираем кавычки
  }
  
  // 3) Извлечение ID из различных форматов Google Drive
  let fileId = '';
  
  // Формат: https://drive.usercontent.google.com/download?id=ID...
  let match = url.match(/drive\.usercontent\.google\.com\/download\?id=([a-zA-Z0-9_-]+)/);
  if (match) {
    fileId = match[1];
  }
  
  // Формат: https://drive.google.com/file/d/ID/view
  if (!fileId) {
    match = url.match(/drive\.google\.com\/file\/d\/([a-zA-Z0-9_-]+)/);
    if (match) fileId = match[1];
  }
  
  // Формат: https://drive.google.com/open?id=ID
  if (!fileId) {
    match = url.match(/drive\.google\.com\/open\?id=([a-zA-Z0-9_-]+)/);
    if (match) fileId = match[1];
  }
  
  // Формат: https://drive.google.com/uc?id=ID
  if (!fileId) {
    match = url.match(/drive\.google\.com\/uc\?id=([a-zA-Z0-9_-]+)/);
    if (match) fileId = match[1];
  }
  
  // Формат: Просто ID (без полного URL)
  if (!fileId && /^[a-zA-Z0-9_-]{25,}$/.test(url)) {
    fileId = url;
  }
  
  // 4) Если нашли ID — формируем правильную ссылку для просмотра
  if (fileId) {
    return `https://lh3.googleusercontent.com/d/${fileId}=s1000?authuser=0`;
  }
  
  // 5) Проверяем, является ли ссылка прямым изображением
  if (/^https?:\/\/.*\.(jpg|jpeg|png|gif|webp|bmp|svg)(\?.*)?$/i.test(url)) {
    return url;
  }
  
  // 6) Для других внешних ссылок — возвращаем как есть
  if (url.startsWith('http')) {
    return url;
  }
  
  // 7) Возвращаем пустую строку, если не распознали
  return '';
}
    function toast(node,msg,ok=true){
      if(!node) return;
      node.className = 'toast ' + (ok?'toast-success':'toast-error');
      node.innerHTML = ok
        ? `<i class="fas fa-check-circle"></i> ${msg}`
        : `<i class="fas fa-exclamation-circle"></i> ${msg}`;
      setTimeout(()=>{ if(node.innerHTML.includes(msg)) node.innerHTML=''; },3000);
    }

    async function api(action, body={}, method='POST'){
      const params = new URLSearchParams({action, ...body});
      let res;
      if(method === 'GET'){
        res = await fetch(`${API_BASE}?${params.toString()}`, {method:'GET'});
      }else{
        res = await fetch(API_BASE, {
          method:'POST',
          headers:{'Content-Type':'application/x-www-form-urlencoded;charset=UTF-8'},
          body: params.toString()
        });
      }
      const data = await res.json().catch(()=>({ok:false,error:'JSON parse error'}));
      if(!data.ok) throw new Error(data.error || 'Ошибка запроса');
      return data;
    }

    function formatMoney(x){
      x = Number(x||0);
      return x.toLocaleString('ru-RU') + ' ₸';
    }

    function downloadCSV(filename, csv){
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    let ADMIN_LOGGED = false;
    let ADMIN_LOGIN = null;
    let ADMIN_NAME = null;
    let ADMIN_ROLE = null;
    let ADMIN_CURRENT_PHONE = null;

    // новые ключи для localStorage
    const ADMIN_SESSION_KEY = 'syb_admin_session';
    const ADMIN_PAGE_KEY    = 'syb_admin_page';

    /* Навигация между блоками админки */
    function switchAdminSubpage(id){
      $$('.admin-subpage').forEach(p=>p.style.display='none');
      const page = document.getElementById(id);
      if(page) page.style.display='block';

      $$('.nav-item').forEach(i=>i.classList.remove('active'));
      $(`.nav-item[data-page="${id}"]`)?.classList.add('active');
      // сохраняем последнюю открытую страницу
      localStorage.setItem(ADMIN_PAGE_KEY, id);
    }

    function initAdminNav(){
      $$('.nav-item').forEach(item=>{
        item.addEventListener('click', ()=>{
          const pageId = item.getAttribute('data-page');
          switchAdminSubpage(pageId);
          if(pageId==='admin-dashboard') loadDashboard();
          if(pageId==='admin-gifts') loadGiftsAdmin();
          if(pageId==='admin-analytics') loadAnalyticsPage();
        });
      });

      $('#btn-go-clients').addEventListener('click', ()=>switchAdminSubpage('admin-clients'));
      $('#btn-go-gifts').addEventListener('click', ()=>{
        switchAdminSubpage('admin-gifts');
        loadGiftsAdmin();
      });
      $('#btn-go-analytics').addEventListener('click', ()=>{
        switchAdminSubpage('admin-analytics');
        loadAnalyticsPage();
      });
    }


    function saveAdminSession(data){
  try{
    localStorage.setItem('syb_admin_session', JSON.stringify(data));
  }catch(e){}
}

function loadAdminSession(){
  try{
    const raw = localStorage.getItem('syb_admin_session');
    if(!raw) return null;
    return JSON.parse(raw);
  }catch(e){
    return null;
  }
}

    /* Авторизация */
    function initAdminAuth(){
      $('#btn-adm-login').addEventListener('click', async ()=>{
        const login = $('#adm-login').value.trim();
        const pass = $('#adm-pass').value.trim();
        try{
          const res = await api('auth_admin',{login,password:pass});
          ADMIN_LOGGED = true;
          ADMIN_LOGIN = res.login;
          ADMIN_NAME = res.name;
          ADMIN_ROLE = res.role;

          // сохраняем сессию
          localStorage.setItem(ADMIN_SESSION_KEY, JSON.stringify({
            login: ADMIN_LOGIN,
            name: ADMIN_NAME,
            role: ADMIN_ROLE
          }));
          localStorage.setItem(ADMIN_PAGE_KEY, 'admin-dashboard');

          $('#admin-login-card').style.display='none';
          $('#admin-layout').style.display='block';

          toast($('#a-toast'),'Вход выполнен',true);
          loadDashboard();
        }catch(err){
          toast($('#a-toast'),err.message || 'Ошибка авторизации',false);
        }
      });
    }

    function restoreAdminSession(){
  try{
    const raw = localStorage.getItem(ADMIN_SESSION_KEY);
    if(!raw) return;

    const saved = JSON.parse(raw);
    if(!saved || !saved.login) return;

    ADMIN_LOGGED = true;
    ADMIN_LOGIN = saved.login;
    ADMIN_NAME = saved.name || '';
    ADMIN_ROLE = saved.role || '';

    // скрываем логин, показываем админку
    $('#admin-login-card').style.display='none';
    $('#admin-layout').style.display='block';

    // какая страница была открыта
    const pageId = localStorage.getItem(ADMIN_PAGE_KEY) || 'admin-dashboard';
    switchAdminSubpage(pageId);

    // подгружаем данные для нужного раздела
    if(pageId === 'admin-dashboard')      loadDashboard();
    else if(pageId === 'admin-gifts')     loadGiftsAdmin();
    else if(pageId === 'admin-analytics') loadAnalyticsPage();
    // для admin-clients отдельно ничего не нужно — всё руками
  }catch(e){
    console.warn('restoreAdminSession error', e);
  }
}

    /* Парсер analytics.csv под новую структуру */
    function parseAnalyticsCSV(csv){
      const lines = csv.split(/\r?\n/).filter(l=>l.trim().length>0);
      if(lines.length<=1) return [];

      const unq = s=>{
        s = s.trim();
        if(s.startsWith('"') && s.endsWith('"')){
          s = s.slice(1,-1).replace(/""/g,'"');
        }
        return s;
      };

      const rows=[];
      for(let i=1;i<lines.length;i++){
        const parts = lines[i].split(',');
        if(parts.length < 3) continue;

        const name  = unq(parts[0] || '');
        const phone = unq(parts[1] || '');
        const sumTotal   = Number(parts[2] || 0);
        const sumNormal  = Number(parts[3] || 0);
        const sumBanquet = Number(parts[4] || 0);

        let gifts = '';
        let tier  = '';
        if(parts.length >= 6){
          if(parts.length === 6){
            gifts = unq(parts[5] || '');
          }else{
            tier  = unq(parts[parts.length-1] || '');
            gifts = unq(parts.slice(5, parts.length-1).join(','));
          }
        }

        rows.push({
          name,
          phone,
          sum_bill_total: sumTotal,
          sum_bill_normal: sumNormal,
          sum_bill_banquet: sumBanquet,
          sum_bill: sumTotal, // алиас для старого кода
          gifts,
          tier
        });
      }
      return rows;
    }

    /* Дашборд */
    async function loadDashboard(){
      try{
        await api('analytics_rebuild',{});
        const a = await api('export_csv',{kind:'analytics'});
        const rows = parseAnalyticsCSV(a.csv);
        const totalClients = rows.length;
        const totalSum = rows.reduce((acc,r)=>acc + (Number(r.sum_bill_total)||0),0);
        let totalGifts = 0;

        rows.forEach(r=>{
          if(r.gifts){
            totalGifts += r.gifts.split(',').map(x=>x.trim()).filter(Boolean).length;
          }
        });

        const box = $('#dash-kpis');
        box.innerHTML='';

        box.append(
          el('div',{class:'kpi-card'},[
            el('div',{class:'kpi-icon primary'},[el('i',{class:'fas fa-money-bill-wave'})]),
            el('div',{class:'kpi-label',html:'Общий оборот чеков'}),
            el('div',{class:'kpi-value',html:formatMoney(totalSum)})
          ]),
          el('div',{class:'kpi-card'},[
            el('div',{class:'kpi-icon success'},[el('i',{class:'fas fa-users'})]),
            el('div',{class:'kpi-label',html:'Всего клиентов'}),
            el('div',{class:'kpi-value',html:String(totalClients)})
          ]),
          el('div',{class:'kpi-card'},[
            el('div',{class:'kpi-icon warning'},[el('i',{class:'fas fa-gift'})]),
            el('div',{class:'kpi-label',html:'Выдано подарков'}),
            el('div',{class:'kpi-value',html:String(totalGifts)})
          ])
        );

        // Топ-4 гостей (Diamond / Gold / Silver / Bronze)
                // Топ-4 гостей (Diamond / Gold / Silver / Bronze)
                const topRows = rows.filter(r=>r.tier).slice(0,4);
        if(topRows.length){
          const topCard = el('div',{class:'kpi-card top4-card'},[
            el('div',{class:'top4-header'},[
              el('div',{},[
                el('div',{class:'top4-title',html:'Топ-4 гостя'}),
                el('div',{class:'top4-sub',html:'По сумме всех чеков за период'}),
              ]),
              el('div',{class:'kpi-icon primary'},[
                el('i',{class:'fas fa-ranking-star'})
              ])
            ]),
            el('div',{class:'top4-list'})
          ]);

          const listNode = topCard.querySelector('.top4-list');

          topRows.forEach((r,idx)=>{
            const tier = r.tier || '';
            let tierClass = 'top4-tier-bronze';
            let tierIcon  = 'fa-award';
            if(tier === 'Diamond'){ tierClass='top4-tier-diamond'; tierIcon='fa-gem'; }
            else if(tier === 'Gold'){ tierClass='top4-tier-gold'; tierIcon='fa-crown'; }
            else if(tier === 'Silver'){ tierClass='top4-tier-silver'; tierIcon='fa-medal'; }

            const item = el('div',{class:'top4-item'},[
              el('div',{class:'top4-rank',html:idx+1}),
              el('div',{class:'top4-main'},[
                el('div',{class:'top4-name',html:r.name}),
                el('div',{class:'top4-phone',html:r.phone})
              ]),
              el('div',{class:'top4-right'},[
                el('div',{class:'top4-sum',html:formatMoney(r.sum_bill_total)}),
                el('div',{class:`top4-tier-badge ${tierClass}`},[
                  el('i',{class:`fas ${tierIcon}`}),
                  document.createTextNode(tier || '—')
                ])
              ])
            ]);

            listNode.append(item);
          });

          box.append(topCard);
        }
      }catch(err){
        toast($('#a-toast'),err.message || 'Ошибка дашборда',false);
      }
    }

    async function loadAnalyticsPage(){
      try{
        const res = await api('export_csv',{kind:'analytics'});
        const rows = parseAnalyticsCSV(res.csv);

        const totalClients = rows.length;
        const totalSum = rows.reduce((acc,r)=>acc + (Number(r.sum_bill_total)||0),0);
        let withGifts=0;
        rows.forEach(r=>{
          if(r.gifts && r.gifts.trim().length>0) withGifts++;
        });

        const kpiBox = $('#kpi');
        kpiBox.innerHTML='';
        kpiBox.append(
          el('div',{class:'kpi-card'},[
            el('div',{class:'kpi-icon primary'},[el('i',{class:'fas fa-users'})]),
            el('div',{class:'kpi-label',html:'Клиенты'}),
            el('div',{class:'kpi-value',html:String(totalClients)})
          ]),
          el('div',{class:'kpi-card'},[
            el('div',{class:'kpi-icon success'},[el('i',{class:'fas fa-coins'})]),
            el('div',{class:'kpi-label',html:'Сумма чеков'}),
            el('div',{class:'kpi-value',html:formatMoney(totalSum)})
          ]),
          el('div',{class:'kpi-card'},[
            el('div',{class:'kpi-icon warning'},[el('i',{class:'fas fa-gift'})]),
            el('div',{class:'kpi-label',html:'Клиенты с подарками'}),
            el('div',{class:'kpi-value',html:String(withGifts)})
          ])
        );

        const tableWrap = $('#analytics-table');
        if(!rows.length){
          tableWrap.innerHTML='<p class="card-subtitle">Пока нет данных аналитики.</p>';
          return;
        }
        const table = el('table');
        const thead = el('thead',{},[
          el('tr',{},[
            el('th',{html:'Имя'}),
            el('th',{html:'Телефон'}),
            el('th',{html:'Сумма всего'}),
            el('th',{html:'Обычные'}),
            el('th',{html:'Банкеты'}),
            el('th',{html:'Статус'}),
            el('th',{html:'Подарки'})
          ])
        ]);
        const tbody = el('tbody');
        rows.forEach(r=>{
          tbody.append(
            el('tr',{},[
              el('td',{html:r.name}),
              el('td',{html:r.phone}),
              el('td',{html:formatMoney(r.sum_bill_total)}),
              el('td',{html:formatMoney(r.sum_bill_normal)}),
              el('td',{html:formatMoney(r.sum_bill_banquet)}),
              el('td',{html:r.tier || '—'}),
              el('td',{html:r.gifts || '—'})
            ])
          );
        });
        table.append(thead,tbody);
        tableWrap.innerHTML='';
        tableWrap.append(table);
      }catch(err){
        toast($('#a-toast'),err.message || 'Ошибка аналитики',false);
      }
    }

    function initAnalyticsButtons(){
      $('#btn-analytics').addEventListener('click', async ()=>{
        try{
          await api('analytics_rebuild',{});
          toast($('#a-toast'),'Аналитика пересчитана',true);
          await loadAnalyticsPage();
        }catch(err){
          toast($('#a-toast'),err.message || 'Ошибка пересчёта аналитики',false);
        }
      });

      $('#btn-export-users').addEventListener('click', async ()=>{
        try{
          const res = await api('export_csv',{kind:'users'});
          downloadCSV('users.csv',res.csv);
        }catch(err){
          toast($('#a-toast'),err.message || 'Ошибка экспорта',false);
        }
      });
      $('#btn-export-bills').addEventListener('click', async ()=>{
        try{
          const res = await api('export_csv',{kind:'bills'});
          downloadCSV('bills.csv',res.csv);
        }catch(err){
          toast($('#a-toast'),err.message || 'Ошибка экспорта',false);
        }
      });
      $('#btn-export-redeem').addEventListener('click', async ()=>{
        try{
          const res = await api('export_csv',{kind:'redeem_log'});
          downloadCSV('redeem_log.csv',res.csv);
        }catch(err){
          toast($('#a-toast'),err.message || 'Ошибка экспорта',false);
        }
      });

      $('#btn-refresh-dashboard').addEventListener('click', loadDashboard);
    }

    /* Клиенты */
    async function loadUsersList(query){
      try{
        const res = await api('users_list',{query:query || ''});
        const list = res.users || [];
        const box = $('#users-list');
        box.innerHTML='';
        if(!list.length){
          box.innerHTML='<p class="card-subtitle">Клиенты не найдены.</p>';
          return;
        }
        list.forEach(u=>{
          const row = el('div',{class:'clickable-row'},[
            el('div',{html:`<strong>${u.name || '-'}</strong><br><span style="font-size:12px;color:var(--text-light);">${u.phone}</span>`}),
            el('div',{class:'pill',html:u.gift ? 'последний подарок: '+u.gift : 'без подарка'})
          ]);
          row.addEventListener('click', ()=>{
            ADMIN_CURRENT_PHONE = u.phone;
            $$('#users-list .clickable-row').forEach(r=>r.classList.remove('active'));
            row.classList.add('active');
            loadClientProfileAdmin(u.phone);
            loadClientBillsAdmin(u.phone);
          });
          box.append(row);
        });
      }catch(err){
        toast($('#a-toast'),err.message || 'Ошибка загрузки клиентов',false);
      }
    }

    async function loadClientProfileAdmin(phone){
      try{
        const res = await api('users_me',{phone});
        const u = res.user;
        const box = $('#client-profile');
        box.innerHTML='';
        const grid = el('div',{class:'user-info-grid'},[
          el('div',{class:'info-card'},[
            el('div',{class:'info-label',html:'Имя'}),
            el('div',{class:'info-value',html:u.name}),
            el('div',{class:'card-subtitle',html:u.phone})
          ]),
          el('div',{class:'info-card'},[
            el('div',{class:'info-label',html:'Сумма чеков'}),
            el('div',{class:'info-value',html:formatMoney(u.lifetime_sum)}),
            el('div',{class:'card-subtitle',html:
              `Обычные: ${formatMoney(u.sum_normal)}<br>Банкеты: ${formatMoney(u.sum_banquet)}`
            })
          ]),
          el('div',{class:'info-card'},[
            el('div',{class:'info-label',html:'Бонусный баланс'}),
            el('div',{class:'info-value',html:formatMoney(u.balance_normal + u.balance_banquet)}),
            el('div',{class:'card-subtitle',html:
              `Обычные баллы: ${formatMoney(u.balance_normal)}<br>Баллы за банкеты: ${formatMoney(u.balance_banquet)}`
            })
          ]),
          el('div',{class:'info-card'},[
            el('div',{class:'info-label',html:'Подарки'}),
            el('div',{class:'info-value',html:u.gifts_got && u.gifts_got.length ? u.gifts_got.join(', ') : '—'})
          ])
        ]);
        box.append(grid);
      }catch(err){
        toast($('#a-toast'),err.message || 'Ошибка профиля',false);
      }
    }

    async function loadClientBillsAdmin(phone){
      try{
        const res = await api('bills_list',{phone});
        const bills = res.bills || [];
        const box = $('#bills-list');
        box.innerHTML='';
        if(!bills.length){
          box.innerHTML='<p class="card-subtitle">Пока нет чеков.</p>';
          return;
        }
        const table = el('table');
        const thead = el('thead',{},[
          el('tr',{},[
            el('th',{html:'Дата'}),
            el('th',{html:'Телефон'}),
            el('th',{html:'Тип'}),
            el('th',{html:'Сумма'})
          ])
        ]);
        const tbody = el('tbody');
        bills.sort((a,b)=>new Date(b.date)-new Date(a.date));
        bills.forEach(b=>{
          const tLabel = b.bill_type === 'banquet' ? 'Банкет' : 'Обычный';
          tbody.append(
            el('tr',{},[
              el('td',{html:String(b.date)}),
              el('td',{html:b.phone}),
              el('td',{html:tLabel}),
              el('td',{html:formatMoney(b.bill)})
            ])
          );
        });
        table.append(thead,tbody);
        box.append(table);
      }catch(err){
        toast($('#a-toast'),err.message || 'Ошибка чеков',false);
      }
    }

    function initClientsAdmin(){
      $('#btn-add-user').addEventListener('click', async ()=>{
        const name = $('#new-name').value.trim();
        const phone = normPhone($('#new-phone').value.trim());
        if(!name || !phone){
          toast($('#a-toast'),'Имя и телефон обязательны',false);
          return;
        }
        try{
          await api('users_create',{name,phone,admin_login:ADMIN_LOGIN || ''});
          toast($('#a-toast'),'Клиент создан',true);
          $('#new-name').value='';
          $('#new-phone').value='';
          await loadUsersList($('#users-q').value.trim());
        }catch(err){
          toast($('#a-toast'),err.message || 'Ошибка создания клиента',false);
        }
      });

      let usersSearchTimeout=null;
      $('#users-q').addEventListener('input', ()=>{
        clearTimeout(usersSearchTimeout);
        usersSearchTimeout=setTimeout(()=>{
          loadUsersList($('#users-q').value.trim());
        },300);
      });

      $('#btn-add-bill').addEventListener('click', async ()=>{
        if(!ADMIN_CURRENT_PHONE){
          toast($('#a-toast'),'Сначала выберите клиента',false);
          return;
        }
        const sum = Number($('#bill-sum').value);
        const billType = $('#bill-type').value || 'normal';
        if(!(sum>0)){
          toast($('#a-toast'),'Введите сумму чека',false);
          return;
        }
        try{
          await api('bills_add',{
            phone:ADMIN_CURRENT_PHONE,
            bill:sum,
            bill_type:billType,
            admin_login:ADMIN_LOGIN || ''
          });
          $('#bill-sum').value='';
          toast($('#a-toast'),'Чек добавлен',true);
          await loadClientBillsAdmin(ADMIN_CURRENT_PHONE);
          await loadClientProfileAdmin(ADMIN_CURRENT_PHONE);
          await loadDashboard();
        }catch(err){
          toast($('#a-toast'),err.message || 'Ошибка добавления чека',false);
        }
      });
    }

    /* Подарки */
    async function loadGiftsAdmin(){
      try{
        const res = await api('gifts_list',{});
        const gifts = res.gifts || [];
        const box = $('#gifts-admin');
        box.innerHTML='';
        if(!gifts.length){
          box.innerHTML='<p class="card-subtitle">Каталог подарков пуст.</p>';
          return;
        }
        gifts.forEach(g=>{
          const left = Number(g.left || 0);
          const card = el('div',{class:'gift-card'});
          if(left<=0){
            card.append(el('div',{class:'gift-out',html:'Нет в наличии'}));
          }
          const img = el('img',{
            class:'gift-image',
            src: normalizePhotoUrl(g.photo) || 'https://via.placeholder.com/400x300?text=Gift'
          });
          const gotCount = g.user_got ? g.user_got.split(',').filter(v=>v.trim().length>0).length : 0;

          const typeLabel = (g.bonus_type === 'banquet')
            ? 'Баллы за банкеты'
            : 'Обычные баллы';

              const btnEdit = el('button',{class:'btn btn-outline btn-sm'},[
              el('i',{class:'fas fa-pen'}),
              document.createTextNode('Редактировать')
            ]);
            const btnDel = el('button',{class:'btn btn-danger btn-sm'},[
              el('i',{class:'fas fa-trash'}),
              document.createTextNode('Удалить')
            ]);

          btnEdit.addEventListener('click', ()=>{
            $('#g-name').value = g.name;
            $('#g-price').value = g.price || '';
            $('#g-photo').value = g.photo || '';
            $('#g-left').value = left || '';
            $('#g-bonus-type').value = g.bonus_type || 'normal';
          });

          btnDel.addEventListener('click', async ()=>{
            if(!confirm(`Удалить подарок «${g.name}»?`)) return;
            try{
              await api('gifts_delete',{name:g.name});
              toast($('#a-toast'),'Подарок удалён',true);
              await loadGiftsAdmin();
            }catch(err){
              toast($('#a-toast'),err.message || 'Ошибка удаления подарка',false);
            }
          });

          const content = el('div',{class:'gift-content'},[
            el('div',{class:'gift-title',html:g.name}),
            el('div',{class:'gift-price',html:`Цена: ${formatMoney(g.price)}`}),
            el('div',{class:'gift-left',html:`Остаток: ${left} шт.`}),
            el('div',{class:'card-subtitle',html:`Тип бонусов: ${typeLabel}`}),
            el('div',{class:'card-subtitle',html:`Выдано: ${gotCount} клиентам`})
          ]);

          card.append(img,content);
          box.append(card);
        });
      }catch(err){
        toast($('#a-toast'),err.message || 'Ошибка загрузки подарков',false);
      }
    }

    function initGiftsAdmin(){
      $('#btn-g-create').addEventListener('click', async ()=>{
        const name = $('#g-name').value.trim();
        const price = Number($('#g-price').value || 0);
        const photo = $('#g-photo').value.trim();
        const left = Number($('#g-left').value || 0);
        const bonusType = $('#g-bonus-type').value || 'normal';
        if(!name){
          toast($('#a-toast'),'Введите название подарка',false);
          return;
        }
        try{
          try{
            await api('gifts_update',{name,price,photo,left,bonus_type:bonusType});
          }catch(err){
            if(String(err.message||'').includes('Сыйлық табылмады') || String(err.message||'').includes('не найден')){
              await api('gifts_create',{name,price,photo,left,bonus_type:bonusType});
            }else{
              throw err;
            }
          }
          toast($('#a-toast'),'Подарок сохранён',true);
          await loadGiftsAdmin();
        }catch(err){
          toast($('#a-toast'),err.message || 'Ошибка сохранения подарка',false);
        }
      });
    }

    /* Доступные подарки для выдачи */
    async function refreshAdminRedeemCards(){
      const phoneRaw = $('#r-phone').value.trim();
      const phone = normPhone(phoneRaw);
      const listBox = $('#redeem-gifts-list');

      listBox.innerHTML = '';

      if(!phone){
        listBox.innerHTML = '<p class="card-subtitle">Введите телефон клиента, чтобы увидеть подарки.</p>';
        return;
      }

      try{
        const uRes = await api('users_me',{phone});
        const user = uRes.user;

        const gRes = await api('gifts_list',{});
        const gifts = gRes.gifts || [];

        if(!gifts.length){
          listBox.innerHTML = '<p class="card-subtitle">Каталог подарков пуст.</p>';
          return;
        }

        const entries = gifts.map(g=>{
          const left = Number(g.left || 0);
          const price = Number(g.price || 0);
          const type = g.bonus_type === 'banquet' ? 'banquet' : 'normal';
          const balance = type === 'banquet'
            ? user.balance_banquet
            : user.balance_normal;
          const canGive = left > 0 && balance >= price;
          return {gift:g,left,price,type,balance,canGive};
        });

        // сначала доступные, потом недоступные — без дублей
        entries.sort((a,b)=>Number(b.canGive)-Number(a.canGive));

        entries.forEach(entry=>{
          const {gift,left,price,type,balance,canGive} = entry;
          const typeLabel = type === 'banquet'
            ? 'банкетные баллы'
            : 'обычные баллы';

          const card = el('div',{class:'redeem-gift-card '+(canGive?'available':'locked')});
          const img = el('img',{
            src: normalizePhotoUrl(gift.photo) || 'https://via.placeholder.com/200x150?text=Gift'
          });

          const main = el('div',{class:'redeem-gift-main'});
          main.append(
            el('div',{class:'redeem-gift-title',html:gift.name}),
            el('div',{class:'redeem-gift-price',html:`Цена: ${formatMoney(price)} (${typeLabel})`}),
            el('div',{class:'redeem-gift-balance',html:`Остаток: ${left} шт.`}),
            el('div',{class:'redeem-gift-balance',html:`Баланс клиента по этому типу: ${formatMoney(balance)}`})
          );

          if(canGive){
            main.append(
              el('div',{class:'redeem-gift-note redeem-gift-note-ok',html:'Можно выдать 🎁'})
            );
            const btn = el('button',{class:'btn btn-primary btn-sm redeem-gift-btn'},[
              el('i',{class:'fas fa-gift'}),
              document.createTextNode('Выдать этот подарок')
            ]);
            btn.addEventListener('click', async ()=>{
              try{
                await api('redeem',{phone,giftName:gift.name,actor:ADMIN_LOGIN || 'admin'});
                toast($('#a-toast'),'Подарок выдан',true);
                await loadDashboard();
                await refreshAdminRedeemCards();
              }catch(err){
                toast($('#a-toast'),err.message || 'Ошибка выдачи подарка',false);
              }
            });
            main.append(btn);
          }else{
            let reason = '';
            if(left <= 0){
              reason = 'Подарок закончился.';
            }else if(balance < price){
              reason = 'Бонусов не хватает.';
            }
            main.append(
              el('div',{class:'redeem-gift-note redeem-gift-note-bad',html:reason || 'Сейчас выдать нельзя.'})
            );
          }

          card.append(img,main);
          listBox.append(card);
        });
      }catch(err){
        listBox.innerHTML = '<p class="card-subtitle">Ошибка загрузки подарков.</p>';
        toast($('#a-toast'),err.message || 'Ошибка загрузки подарков для выдачи',false);
      }
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      initAdminAuth();
      initAdminNav();
      initAnalyticsButtons();
      initClientsAdmin();
      initGiftsAdmin();

      // попытаться восстановить сессию и страницу
      restoreAdminSession();

      let redeemTimer=null;
      $('#r-phone').addEventListener('input', ()=>{
        clearTimeout(redeemTimer);
        redeemTimer = setTimeout(refreshAdminRedeemCards,400);
      });
    });
  </script>
  <script>
    let logoutTimer;
    
    // Запуск таймера
    function startLogoutTimer() {
      clearTimeout(logoutTimer);
    
      // 15 минут бездействия
      logoutTimer = setTimeout(() => {
    
        // Удаляем САМОЕ ВАЖНОЕ — ключ админ-сессии
        localStorage.removeItem('syb_admin_session');
    
        // Удаляем сохранённую страницу
        localStorage.removeItem('syb_admin_page');
    
        // Перезагружаем на страницу логина
        window.location.href = 'admin.html';
    
      }, 24 * 60 * 60 * 1000);
    }
    
    // Сбрасывать таймер при любой активности
    window.onload = startLogoutTimer;
    document.onclick = startLogoutTimer;
    document.onkeypress = startLogoutTimer;
    document.onmousemove = startLogoutTimer;
    document.onscroll = startLogoutTimer;
    </script>
</body>
</html>