<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Finance Kanban</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg-page:#f5f5f7;
      --bg-header:#ffffff;
      --bg-column:#ffffff;
      --bg-card:#f9fafb;
      --border-soft:#e5e7eb;
      --border-strong:#d1d5db;
      --text-main:#111827;
      --text-muted:#6b7280;
      --accent:#2563eb;
      --accent-soft:#eff6ff;
      --danger:#b91c1c;
      --radius-lg:14px;
      --radius-md:10px;
      --shadow-soft:0 10px 25px rgba(15,23,42,0.08);
      --shadow-card:0 4px 10px rgba(15,23,42,0.06);
    }

    *{box-sizing:border-box;}

    body{
      margin:0;
      font-family:"Inter",system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
      background:var(--bg-page);
      color:var(--text-main);
    }

    .app{
      max-width:1200px;
      margin:0 auto;
      padding:16px 12px 24px;
    }

    header{
      background:var(--bg-header);
      border-radius:18px;
      padding:14px 16px;
      box-shadow:var(--shadow-soft);
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      align-items:center;
      margin-bottom:16px;
      border:1px solid #e5e7eb;
    }

    .title-block{
      flex:1;
      min-width:220px;
    }

    h1{
      margin:0;
      font-size:20px;
      font-weight:600;
      letter-spacing:0.08em;
      text-transform:uppercase;
    }

    .subtitle{
      margin-top:4px;
      font-size:12px;
      color:var(--text-muted);
    }

    .top-controls{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }

    .tab-buttons{
      display:flex;
      background:#f3f4f6;
      border-radius:999px;
      padding:3px;
      border:1px solid #e5e7eb;
    }
    .tab-btn{
      border:none;
      background:transparent;
      padding:6px 14px;
      border-radius:999px;
      font-size:13px;
      cursor:pointer;
      color:var(--text-muted);
      display:flex;
      align-items:center;
      gap:6px;
    }
    .tab-btn span.dot{
      width:6px;
      height:6px;
      border-radius:999px;
      background:#9ca3af;
    }
    .tab-btn.active{
      background:#111827;
      color:#f9fafb;
      font-weight:500;
    }
    .tab-btn.active span.dot{
      background:#f9fafb;
    }

    .filters{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      font-size:12px;
    }
    select,input[type="date"]{
      font-family:inherit;
      font-size:12px;
      padding:5px 8px;
      border-radius:8px;
      border:1px solid #d1d5db;
      background:#ffffff;
      color:var(--text-main);
      outline:none;
    }
    select:focus,input[type="date"]:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 1px var(--accent-soft);
    }

    main{
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    .board{
      background:#f9fafb;
      border-radius:18px;
      padding:12px;
      box-shadow:var(--shadow-soft);
      border:1px solid #e5e7eb;
    }

    .board.hidden{display:none;}

    .board-header{
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:0.14em;
      color:var(--text-muted);
      margin-bottom:6px;
    }

    .columns{
      display:flex;
      gap:12px;
      overflow-x:auto;
      padding-bottom:6px;
    }

    .column{
      background:var(--bg-column);
      border-radius:var(--radius-lg);
      min-width:220px;
      max-width:260px;
      flex:1;
      border:1px solid var(--border-soft);
      box-shadow:var(--shadow-soft);
      display:flex;
      flex-direction:column;
      max-height:70vh;
    }

    .column-header{
      padding:10px 10px 6px;
      border-bottom:1px solid #e5e7eb;
    }
    .column-title-row{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap:6px;
    }
    .column-title{
      font-size:12px;
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:0.14em;
    }
    .column-total{
      font-size:11px;
      color:var(--text-muted);
      text-align:right;
      margin-top:4px;
      min-height:14px;
    }

    .add-btn{
      margin:6px 10px 8px;
      font-size:11px;
      padding:5px 9px;
      border-radius:999px;
      border:1px dashed var(--border-strong);
      background:#f9fafb;
      color:var(--text-muted);
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .add-btn span.plus{
      font-size:16px;
      line-height:0;
      color:var(--accent);
    }
    .add-btn:hover{
      background:#eff6ff;
      border-style:solid;
    }

    .column-body{
      padding:0 8px 8px;
      overflow-y:auto;
      flex:1;
    }

    .card{
      background:var(--bg-card);
      border-radius:var(--radius-md);
      border:1px solid var(--border-soft);
      padding:8px 8px 6px;
      margin-bottom:6px;
      box-shadow:var(--shadow-card);
      cursor:grab;
    }
    .card.dragging{
      opacity:0.6;
      box-shadow:0 0 0 2px var(--accent-soft);
    }

    .card-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:6px;
      margin-bottom:4px;
    }
    .card-title{
      font-size:12px;
      font-weight:500;
      word-break:break-word;
    }
    .card-meta{
      display:flex;
      gap:4px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .pill{
      padding:2px 6px;
      border-radius:999px;
      font-size:10px;
      border:1px solid #e5e7eb;
      background:#f3f4f6;
      color:var(--text-muted);
      white-space:nowrap;
    }
    .pill.type-income{border-color:#bbf7d0;background:#ecfdf3;color:#166534;}
    .pill.type-expense{border-color:#fecaca;background:#fef2f2;color:#991b1b;}

    .card-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
      font-size:11px;
      margin-bottom:2px;
    }
    .amount-block{
      display:flex;
      align-items:center;
      gap:4px;
      font-variant-numeric:tabular-nums;
    }
    .amount{
      font-weight:600;
    }
    .comment{
      flex:1;
      text-align:right;
      color:var(--text-muted);
      font-style:italic;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    .card-footer{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:4px;
      font-size:10px;
      color:var(--text-muted);
    }

    .card-actions{
      display:flex;
      gap:6px;
    }
    .icon-btn{
      border:none;
      background:transparent;
      padding:0;
      font-size:11px;
      cursor:pointer;
      color:var(--text-muted);
    }
    .icon-btn:hover{
      color:var(--accent);
    }
    .icon-btn.delete:hover{
      color:var(--danger);
    }

    .drop-target{
      border:1px dashed var(--accent);
    }

    .summary{
      background:#ffffff;
      border-radius:16px;
      padding:10px 12px;
      box-shadow:var(--shadow-soft);
      border:1px solid #e5e7eb;
      font-size:11px;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .summary-title{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.14em;
      color:var(--text-muted);
      margin-bottom:2px;
    }
    .summary-row{
      display:flex;
      flex-wrap:wrap;
      justify-content:space-between;
      gap:4px;
    }
    .summary-block{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
    }
    .summary-label{
      font-weight:500;
    }
    .summary-value{
      font-variant-numeric:tabular-nums;
    }

    /* MONTHLY TABLE */
    .table-wrapper{
      margin-top:4px;
      overflow-x:auto;
    }
    table.monthly-table{
      width:100%;
      border-collapse:collapse;
      font-size:11px;
      background:#ffffff;
      border-radius:12px;
      overflow:hidden;
    }
    table.monthly-table th,
    table.monthly-table td{
      padding:4px 6px;
      border:1px solid #e5e7eb;
      text-align:right;
      font-variant-numeric:tabular-nums;
    }
    table.monthly-table th:first-child,
    table.monthly-table td:first-child{
      text-align:left;
      min-width:90px;
    }
    table.monthly-table th{
      background:#111827;
      color:#f9fafb;
    }
    table.monthly-table tfoot td{
      font-weight:600;
      background:#f3f4f6;
    }

    /* ANALYTICS & P&L TABLES */
    .analytics-table-wrapper{
      margin-top:8px;
      margin-bottom:10px;
      overflow-x:auto;
    }
    table.analytics-table{
      width:100%;
      border-collapse:collapse;
      font-size:11px;
      background:#ffffff;
      border-radius:12px;
      overflow:hidden;
    }
    table.analytics-table th,
    table.analytics-table td{
      padding:4px 6px;
      border:1px solid #e5e7eb;
      text-align:right;
      font-variant-numeric:tabular-nums;
    }
    table.analytics-table th:first-child,
    table.analytics-table td:first-child{
      text-align:left;
      min-width:90px;
    }
    table.analytics-table thead{
      background:#111827;
      color:#f9fafb;
    }
    table.analytics-table tfoot td{
      font-weight:600;
      background:#f3f4f6;
    }

    .analytics-note{
      font-size:11px;
      color:var(--text-muted);
      margin-bottom:6px;
    }

    /* DAILY DATE TABS */
    .daily-dates{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin:4px 0 8px;
    }
    .date-tab{
      border:none;
      border-radius:999px;
      padding:4px 10px;
      font-size:11px;
      background:#e5e7eb;
      color:#374151;
      cursor:pointer;
      white-space:nowrap;
    }
    .date-tab.active{
      background:#111827;
      color:#f9fafb;
      font-weight:500;
    }

    /* MONTHLY MONTH TABS */
    .monthly-months{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin:4px 0 8px;
    }
    .month-tab{
      border:none;
      border-radius:999px;
      padding:4px 10px;
      font-size:11px;
      background:#e5e7eb;
      color:#374151;
      cursor:pointer;
      white-space:nowrap;
    }
    .month-tab.active{
      background:#111827;
      color:#f9fafb;
      font-weight:500;
    }

    @media (max-width:768px){
      header{
        flex-direction:column;
        align-items:flex-start;
      }
      .top-controls{
        width:100%;
        justify-content:space-between;
      }
      .columns{
        max-height:none;
      }
      .column{
        max-height:none;
      }
    }

    /* ===== MODAL ===== */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,0.45);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:50;
    }
    .modal-hidden{
      display:none;
    }
    .modal{
      background:#ffffff;
      border-radius:18px;
      padding:16px 18px 14px;
      width:100%;
      max-width:420px;
      box-shadow:0 20px 40px rgba(15,23,42,0.35);
      border:1px solid #e5e7eb;
    }
    .modal-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:10px;
    }
    .modal-title{
      font-size:14px;
      font-weight:600;
    }
    .modal-close{
      border:none;
      background:transparent;
      font-size:18px;
      line-height:1;
      cursor:pointer;
      color:var(--text-muted);
    }
    .modal-close:hover{
      color:var(--text-main);
    }
    .modal-form{
      display:flex;
      flex-direction:column;
      gap:8px;
      font-size:12px;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:3px;
    }
    .field-row{
      display:flex;
      gap:8px;
    }
    .field label{
      font-size:11px;
      color:var(--text-muted);
    }
    .field input,
    .field select,
    .field textarea{
      font-family:inherit;
      font-size:12px;
      padding:6px 8px;
      border-radius:8px;
      border:1px solid #d1d5db;
      outline:none;
      background:#ffffff;
    }
    .field textarea{
      resize:vertical;
      min-height:50px;
    }
    .field input:focus,
    .field select:focus,
    .field textarea:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 1px var(--accent-soft);
    }
    .modal-error{
      font-size:11px;
      color:var(--danger);
      min-height:14px;
    }
    .modal-footer{
      margin-top:6px;
      display:flex;
      justify-content:flex-end;
      gap:8px;
    }
    .btn{
      border:none;
      border-radius:999px;
      font-size:12px;
      padding:6px 14px;
      cursor:pointer;
      font-weight:500;
    }
    .btn-secondary{
      background:#e5e7eb;
      color:#111827;
    }
    .btn-secondary:hover{
      background:#d1d5db;
    }
    .btn-primary{
      background:#111827;
      color:#f9fafb;
    }
    .btn-primary:hover{
      background:#020617;
    }
  </style>
</head>
<body>
<div class="app">
  <header>
    <div class="title-block">
      <h1>Finance Kanban</h1>
      <div class="subtitle">
        Daily expenses & income with categories, payment methods, currencies and analytics. All data stays in your browser (localStorage).
      </div>
    </div>
    <div class="top-controls">
      <div class="tab-buttons">
        <button class="tab-btn active" data-view="daily">
          <span class="dot"></span>Daily
        </button>
        <button class="tab-btn" data-view="monthly">
          <span class="dot"></span>Monthly
        </button>
        <button class="tab-btn" data-view="analytics">
          <span class="dot"></span>Analytics
        </button>
      </div>
      <div class="filters">
        <span>Period:</span>
        <select id="filter-mode">
          <option value="today">Today</option>
          <option value="thisWeek">This week</option>
          <option value="thisMonth" selected>This month</option>
          <option value="custom">Custom</option>
        </select>
        <span id="custom-range" style="display:none;">
          From <input type="date" id="date-from">
          To <input type="date" id="date-to">
        </span>
      </div>
    </div>
  </header>

  <main>
    <!-- DAILY BOARD -->
    <section class="board" id="board-daily">
      <div class="board-header">Daily board</div>
      <div class="daily-dates" id="daily-date-tabs"></div>
      <div class="columns" id="columns-daily"></div>
    </section>

    <!-- MONTHLY TABLE + P&L -->
    <section class="board hidden" id="board-monthly">
      <div class="board-header">Monthly (all cards, sorted by date)</div>
      <div class="monthly-months" id="monthly-month-tabs"></div>
      <div class="table-wrapper">
        <table class="monthly-table" id="monthly-table"></table>
      </div>

      <div class="analytics-note" style="margin-top:10px;">
        Profit &amp; Loss summary for the same period (per currency, как в Excel-отчёте).
      </div>
      <div id="monthly-pl"></div>
    </section>

    <!-- ANALYTICS PAGE -->
    <section class="board hidden" id="analytics-page">
      <div class="board-header">Analytics (Daily board)</div>
      <div class="analytics-note">
        Report is built from all transactions for the selected period. Rows — dates, columns — Fixed / Variable / Additional / Guest, totals by currency.
      </div>
      <div id="analytics-tables"></div>
    </section>

    <!-- SUMMARY -->
    <section class="summary" id="summary"></section>
  </main>
</div>

<!-- MODAL: ADD / EDIT CARD -->
<div id="card-modal-backdrop" class="modal-backdrop modal-hidden">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="modal-title">Add item</div>
      <button class="modal-close" type="button" id="modal-close-btn">&times;</button>
    </div>
    <form id="card-form" class="modal-form">
      <div class="field">
        <label>Column</label>
        <input id="field-column-name" type="text" readonly>
      </div>

      <div class="field">
        <label for="field-category">Category *</label>
        <select id="field-category"></select>
      </div>

      <div class="field">
        <label for="field-title">Name (auto from category, можно менять)</label>
        <input id="field-title" type="text">
      </div>

      <div class="field-row">
        <div class="field" style="flex:1;">
          <label for="field-amount">Amount *</label>
          <input id="field-amount" type="number" min="0" step="0.01" required>
        </div>
        <div class="field" style="width:90px;">
          <label for="field-currency">Currency *</label>
          <select id="field-currency">
            <option value="KZT">KZT</option>
            <option value="USD">USD</option>
          </select>
        </div>
      </div>

      <div class="field-row">
        <div class="field" style="flex:1;">
          <label for="field-payment">Payment method *</label>
          <select id="field-payment">
            <option value="cash">Cash</option>
            <option value="kaspi">Kaspi</option>
            <option value="halyk">Halyk</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div class="field" style="flex:1;">
          <label for="field-type">Type *</label>
          <select id="field-type">
            <option value="expense">Expense</option>
            <option value="income">Income</option>
          </select>
        </div>
      </div>

      <div class="field">
        <label for="field-date">Date (YYYY-MM-DD) *</label>
        <input id="field-date" type="date" required>
      </div>

      <div class="field">
        <label for="field-comment">Comment</label>
        <textarea id="field-comment" placeholder="Short note about this item"></textarea>
      </div>

      <div class="modal-error" id="modal-error"></div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" id="modal-cancel-btn">Cancel</button>
        <button type="submit" class="btn btn-primary">Save</button>
      </div>

      <!-- hidden -->
      <input type="hidden" id="field-id">
      <input type="hidden" id="field-column">
      <input type="hidden" id="field-mode">
    </form>
  </div>
</div>

<script>
  // ===== CONFIG =====
  const STORAGE_KEY = 'finance_kanban_items_v2';

  const COLUMNS = [
    { key: 'fixed', label: 'Fixed' },
    { key: 'variable', label: 'Variable' },
    { key: 'additional', label: 'Additional' },
    { key: 'guest', label: 'Guest expences' }
  ];

  const CATEGORY_OPTIONS = {
    fixed: [
      'RENT',
      'KITE TRAVEL CARS',
      'PHONE BALANCE'
    ],
    variable: [
      'SALARY',
      'OFFICE EXPENCES',
      'CAR REPAIR',
      'CAR EXPENCES',
      'SIM CARDS',
      'BRANDING',
      'SHYMBULAK'
    ],
    additional: [
      'DIRECTORS',
      'BUISNESS TRIP',
      'BLOGGER EXPENCES',
      'GAS/CARWASH',
      'HOTEL',
      'PARTNER LUNCH',
      'PARTNER SOUVENIERS'
    ],
    guest: [
      'GUEST LUNCH',
      'GUEST SOUVENIERS',
      'OTHER EXPENCES'
    ]
  };

  const currencySymbols = {
    KZT: '₸',
    USD: '$'
  };

  // P&L row configuration
  const PL_ROWS = [
    { key:'REV_TOUR',          label:'Revenue by tour',        group:'revenue' },
    { key:'REV_HOTEL',         label:'Hotel rooms',            group:'revenue' },
    { key:'REV_CASHBACKS',     label:'Cashbacks',              group:'revenue' },
    { key:'REV_OTHER',         label:'Other revenue',          group:'revenue' },

    { key:'COGS_ACCOM',        label:'Cost of accomodation',   group:'cogs' },
    { key:'COGS_TOUR',         label:'Cost of tour',           group:'cogs' },
    { key:'COGS_TRANSPORT',    label:'Cost of transport',      group:'cogs' },
    { key:'COGS_GUIDES',       label:'Cost of guides',         group:'cogs' },
    { key:'COGS_SERVICE',      label:'Cost of servise',        group:'cogs' },
    { key:'COGS_GUEST_EXP',    label:'Cost of guest expences', group:'cogs' },
    { key:'COGS_TRANSFERS',    label:'Cost of transfers',      group:'cogs' },
    { key:'COGS_SIM',          label:'Cost of sim cards',      group:'cogs' },
    { key:'COGS_GAS',          label:'Cost of gas',            group:'cogs' },
    { key:'COGS_CARWASH',      label:'Cost of carwash',        group:'cogs' },
    { key:'COGS_PARKING',      label:'Cost of parking',        group:'cogs' },

    { key:'OPEX_SALES_COMM',   label:'Sales comissions',       group:'opex' },
    { key:'OPEX_OFFICE',       label:'Office expenses',        group:'opex' },
    { key:'OPEX_CAR_REPAIR',   label:'Car repair',             group:'opex' },
    { key:'OPEX_BRANDING',     label:'Branding',               group:'opex' },
    { key:'OPEX_BLOGGERS',     label:'Bloggers expenses',      group:'opex' },
    { key:'OPEX_GUEST_LUNCH',  label:'Guests lunch',           group:'opex' },
    { key:'OPEX_GUEST_SOUV',   label:'Guests souvenirs',       group:'opex' },
    { key:'OPEX_OTHER',        label:'Other spendings',        group:'opex' },
    { key:'OPEX_SALARY_FUND',  label:'Salary fund',            group:'opex' }
  ];

  function mapCategoryToPLKey(catUpper){
    switch (catUpper) {
      case 'REVENUE BY TOUR': return 'REV_TOUR';
      case 'HOTEL ROOMS': return 'REV_HOTEL';
      case 'CASHBACKS': return 'REV_CASHBACKS';
      case 'OTHER REVENUE': return 'REV_OTHER';

      case 'COST OF ACCOMODATION': return 'COGS_ACCOM';
      case 'COST OF TOUR': return 'COGS_TOUR';
      case 'COST OF TRANSPORT': return 'COGS_TRANSPORT';
      case 'COST OF GUIDES': return 'COGS_GUIDES';
      case 'COST OF SERVISE': return 'COGS_SERVICE';
      case 'COST OF GUEST EXPENCES': return 'COGS_GUEST_EXP';
      case 'COST OF TRANSFERS': return 'COGS_TRANSFERS';
      case 'COST OF SIM CARDS': return 'COGS_SIM';
      case 'COST OF GAS': return 'COGS_GAS';
      case 'COST OF CARWASH': return 'COGS_CARWASH';
      case 'COST OF PARKING': return 'COGS_PARKING';

      case 'SALES COMISSIONS': return 'OPEX_SALES_COMM';
      case 'OFFICE EXPENCES': return 'OPEX_OFFICE';
      case 'CAR REPAIR': return 'OPEX_CAR_REPAIR';
      case 'BRANDING': return 'OPEX_BRANDING';
      case 'BLOGGERS EXPENCES': return 'OPEX_BLOGGERS';
      case 'GUEST LUNCH': return 'OPEX_GUEST_LUNCH';
      case 'GUEST SOUVENIERS': return 'OPEX_GUEST_SOUV';
      case 'OTHER SPENDINGS': return 'OPEX_OTHER';
      case 'SALARY FUND': return 'OPEX_SALARY_FUND';
      default: return null;
    }
  }

  function createEmptyPLState(){
    const rows = {};
    PL_ROWS.forEach(r => rows[r.key] = 0);
    return {
      rows,
      grossRevenue:0,
      vat:0,
      commissions:0,
      totalCogs:0,
      netRevenue:0,
      operationalExp:0,
      ebitda:0,
      amortization:0,
      taxes:0,
      netIncome:0
    };
  }

  // ===== STATE =====
  let items = [];
  let filterMode = 'thisMonth';
  let customFrom = null;
  let customTo = null;
  let activeView = 'daily';
  let dragItemId = null;
  let dailySelectedDate = 'all'; // 'all' или конкретная дата YYYY-MM-DD

  // ===== UTIL =====
  function generateId() {
    return 'id-' + Date.now().toString(36) + '-' + Math.random().toString(36).slice(2,8);
  }

  function parseDate(str) {
    if (!str) return null;
    const [y, m, d] = str.split('-').map(Number);
    if (!y || !m || !d) return null;
    return new Date(y, m - 1, d);
  }

  function formatNumber(num) {
    if (isNaN(num)) return '0';
    return num.toLocaleString('ru-RU', { maximumFractionDigits: 2 });
  }

  function todayDateString() {
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  }

  function startOfDay(d) {
    const x = new Date(d);
    x.setHours(0,0,0,0);
    return x;
  }

  function endOfDay(d) {
    const x = new Date(d);
    x.setHours(23,59,59,999);
    return x;
  }

  function getFilterRange() {
    const now = new Date();
    const today = startOfDay(now);
    let from, to;

    if (filterMode === 'today') {
      from = today;
      to = endOfDay(today);
    } else if (filterMode === 'thisWeek') {
      const day = today.getDay();
      const diff = (day + 6) % 7; // Monday start
      from = new Date(today);
      from.setDate(from.getDate() - diff);
      to = new Date(from);
      to.setDate(to.getDate() + 6);
      to = endOfDay(to);
    } else if (filterMode === 'thisMonth') {
      from = new Date(today.getFullYear(), today.getMonth(), 1);
      to = endOfDay(new Date(today.getFullYear(), today.getMonth() + 1, 0));
    } else if (filterMode === 'custom') {
      if (!customFrom || !customTo) return null;
      const f = parseDate(customFrom);
      const t = parseDate(customTo);
      if (!f || !t) return null;
      from = startOfDay(f);
      to = endOfDay(t);
    } else {
      return null;
    }

    return { from, to };
  }

  // только диапазон (без дневного выбора)
  function passesRangeFilter(item) {
    const range = getFilterRange();
    if (!range) return true;
    const d = parseDate(item.date);
    if (!d) return false;
    return d >= range.from && d <= range.to;
  }

  // ===== STORAGE =====
  function loadData() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) {
        items = [];
        seedDemoData();
        saveData();
      } else {
        items = JSON.parse(raw);
      }
    } catch (e) {
      console.error('Failed to load data', e);
      items = [];
      seedDemoData();
      saveData();
    }
  }

  function saveData() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
  }

  function seedDemoData() {
    const today = todayDateString();
    items = [
      {
        id: generateId(),
        column: 'fixed',
        category: 'RENT',
        title: 'Office rent',
        amount: 120000,
        currency: 'KZT',
        payment: 'kaspi',
        type: 'expense',
        date: today,
        comment: 'Main office'
      },
      {
        id: generateId(),
        column: 'variable',
        category: 'GUEST LUNCH',
        title: 'Guest lunch',
        amount: 18000,
        currency: 'KZT',
        payment: 'cash',
        type: 'expense',
        date: today,
        comment: 'Tourists group'
      },
      {
        id: generateId(),
        column: 'additional',
        category: 'BLOGGER EXPENCES',
        title: 'Blog ads',
        amount: 120,
        currency: 'USD',
        payment: 'other',
        type: 'expense',
        date: today,
        comment: 'Instagram promo'
      },
      {
        id: generateId(),
        column: 'variable',
        category: 'REVENUE BY TOUR',
        title: 'Revenue by tour',
        amount: 104000000,
        currency: 'KZT',
        payment: 'kaspi',
        type: 'income',
        date: today,
        comment: 'Example income'
      }
    ];
  }

  // ===== DAILY DATE TABS =====
  function renderDailyDateTabs() {
    const container = document.getElementById('daily-date-tabs');
    if (!container) return;

    const filtered = items.filter(passesRangeFilter);
    const dates = Array.from(new Set(filtered.map(it => it.date))).sort();

    if (!dates.length) {
      container.innerHTML = '';
      return;
    }

    let html = `
      <button class="date-tab ${!dailySelectedDate || dailySelectedDate === 'all' ? 'active' : ''}" data-date="all">
        All
      </button>
    `;

    dates.forEach(d => {
      const active = dailySelectedDate === d ? 'active' : '';
      html += `<button class="date-tab ${active}" data-date="${d}">${d}</button>`;
    });

    container.innerHTML = html;
  }

  // ===== MONTH TABS (MONTHLY) =====
  function renderMonthlyMonthTabs() {
    const container = document.getElementById('monthly-month-tabs');
    if (!container) return;

    if (!items.length) {
      container.innerHTML = '';
      return;
    }

    const monthsSet = new Set();
    items.forEach(it => {
      const d = parseDate(it.date);
      if (!d) return;
      const key = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2,'0')}`;
      monthsSet.add(key);
    });
    const months = Array.from(monthsSet).sort();
    if (!months.length) {
      container.innerHTML = '';
      return;
    }

    const range = getFilterRange();
    let currentKey = null;
    if (range) {
      const d = range.from;
      currentKey = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2,'0')}`;
    }

    const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

    let html = '';
    months.forEach(key => {
      const [y, m] = key.split('-');
      const label = `${monthNames[parseInt(m,10)-1]} ${y}`;
      const active = key === currentKey ? 'active' : '';
      html += `<button class="month-tab ${active}" data-month-key="${key}">${label}</button>`;
    });

    container.innerHTML = html;
  }

  // ===== RENDER DAILY =====
  function renderDaily() {
    const container = document.getElementById('columns-daily');
    container.innerHTML = '';

    COLUMNS.forEach(col => {
      const colDiv = document.createElement('div');
      colDiv.className = 'column';
      colDiv.dataset.column = col.key;

      const header = document.createElement('div');
      header.className = 'column-header';
      const titleRow = document.createElement('div');
      titleRow.className = 'column-title-row';

      const title = document.createElement('div');
      title.className = 'column-title';
      title.textContent = col.label;

      const headerRight = document.createElement('div');
      headerRight.style.fontSize = '10px';
      headerRight.style.color = 'var(--text-muted)';
      headerRight.textContent = 'per day';

      titleRow.appendChild(title);
      titleRow.appendChild(headerRight);
      header.appendChild(titleRow);

      const total = document.createElement('div');
      total.className = 'column-total';
      header.appendChild(total);

      colDiv.appendChild(header);

      const addBtn = document.createElement('button');
      addBtn.className = 'add-btn';
      addBtn.dataset.action = 'add';
      addBtn.dataset.column = col.key;
      addBtn.innerHTML = `<span class="plus">+</span> Add`;
      colDiv.appendChild(addBtn);

      const body = document.createElement('div');
      body.className = 'column-body';
      body.dataset.dropColumn = col.key;

      const colItems = items
        .filter(it =>
          it.column === col.key &&
          passesRangeFilter(it) &&
          (dailySelectedDate === 'all' || dailySelectedDate === null || it.date === dailySelectedDate)
        )
        .sort((a,b) => (a.date > b.date ? 1 : -1));

      colItems.forEach(it => {
        const card = buildCard(it);
        body.appendChild(card);
      });

      colDiv.appendChild(body);

      container.appendChild(colDiv);

      const totals = calcTotalsForColumn(col.key);
      total.textContent = formatTotalsLabel(totals);
    });
  }

  function buildCard(item) {
    const card = document.createElement('div');
    card.className = 'card';
    card.draggable = true;
    card.dataset.itemId = item.id;

    const cardHeader = document.createElement('div');
    cardHeader.className = 'card-header';

    const title = document.createElement('div');
    title.className = 'card-title';
    title.textContent = item.title || item.category;

    const meta = document.createElement('div');
    meta.className = 'card-meta';

    const typePill = document.createElement('div');
    typePill.className = 'pill ' + (item.type === 'income' ? 'type-income' : 'type-expense');
    typePill.textContent = item.type === 'income' ? 'INCOME' : 'EXPENSE';

    const payPill = document.createElement('div');
    payPill.className = 'pill';
    payPill.textContent =
      item.payment === 'cash' ? 'Cash' :
      item.payment === 'kaspi' ? 'Kaspi' :
      item.payment === 'halyk' ? 'Halyk' : 'Other';

    const curPill = document.createElement('div');
    curPill.className = 'pill';
    curPill.textContent = item.currency;

    meta.appendChild(typePill);
    meta.appendChild(payPill);
    meta.appendChild(curPill);

    cardHeader.appendChild(title);
    cardHeader.appendChild(meta);
    card.appendChild(cardHeader);

    const rowAmount = document.createElement('div');
    rowAmount.className = 'card-row';
    const amountBlock = document.createElement('div');
    amountBlock.className = 'amount-block';

    const symbol = currencySymbols[item.currency] || '';
    const amountSpan = document.createElement('span');
    amountSpan.className = 'amount';
    const signed = item.type === 'expense' ? -item.amount : item.amount;
    amountSpan.textContent = `${symbol} ${formatNumber(signed)}`;

    amountBlock.appendChild(amountSpan);

    const commentSpan = document.createElement('div');
    commentSpan.className = 'comment';
    commentSpan.textContent = item.comment || '';

    rowAmount.appendChild(amountBlock);
    rowAmount.appendChild(commentSpan);
    card.appendChild(rowAmount);

    const rowDate = document.createElement('div');
    rowDate.className = 'card-row';
    const dateLabel = document.createElement('span');
    dateLabel.style.fontSize = '10px';
    dateLabel.textContent = item.date;
    rowDate.appendChild(dateLabel);
    rowDate.appendChild(document.createElement('span'));
    card.appendChild(rowDate);

    const footer = document.createElement('div');
    footer.className = 'card-footer';

    const catSpan = document.createElement('span');
    catSpan.textContent = item.category;

    const actions = document.createElement('div');
    actions.className = 'card-actions';

    const editBtn = document.createElement('button');
    editBtn.className = 'icon-btn edit';
    editBtn.dataset.action = 'edit';
    editBtn.dataset.itemId = item.id;
    editBtn.textContent = 'Edit';

    const delBtn = document.createElement('button');
    delBtn.className = 'icon-btn delete';
    delBtn.dataset.action = 'delete';
    delBtn.dataset.itemId = item.id;
    delBtn.textContent = 'Delete';

    actions.appendChild(editBtn);
    actions.appendChild(delBtn);

    footer.appendChild(catSpan);
    footer.appendChild(actions);

    card.appendChild(footer);

    card.addEventListener('dragstart', handleDragStart);
    card.addEventListener('dragend', handleDragEnd);

    return card;
  }

  // ===== TOTALS =====
  function calcTotalsForColumn(columnKey) {
    const result = {
      KZT: { income:0, expense:0 },
      USD: { income:0, expense:0 }
    };
    items.forEach(it => {
      if (it.column !== columnKey) return;
      if (!passesRangeFilter(it)) return;
      if (dailySelectedDate !== 'all' && dailySelectedDate !== null && it.date !== dailySelectedDate) return;
      const cur = it.currency || 'KZT';
      if (!result[cur]) result[cur] = { income:0, expense:0 };
      if (it.type === 'income') {
        result[cur].income += it.amount;
      } else {
        result[cur].expense += it.amount;
      }
    });
    return result;
  }

  function calcTotalsAll() {
    const result = {
      KZT: { income:0, expense:0 },
      USD: { income:0, expense:0 }
    };
    items.forEach(it => {
      if (!passesRangeFilter(it)) return; // здесь дневной фильтр НЕ учитываем
      const cur = it.currency || 'KZT';
      if (!result[cur]) result[cur] = { income:0, expense:0 };
      if (it.type === 'income') {
        result[cur].income += it.amount;
      } else {
        result[cur].expense += it.amount;
      }
    });
    return result;
  }

  function formatTotalsLabel(totals) {
    const parts = [];
    Object.keys(totals).forEach(cur => {
      const t = totals[cur];
      if (!t.income && !t.expense) return;
      const net = t.income - t.expense;
      parts.push(`${cur} ${formatNumber(net)}`);
    });
    return parts.join(' • ');
  }

  function renderSummary() {
    const totals = calcTotalsAll();
    const el = document.getElementById('summary');

    const currencies = Object.keys(totals).filter(cur => totals[cur].income || totals[cur].expense);

    const blocks = currencies.map(cur => {
      const t = totals[cur];
      const income = t.income;
      const expense = t.expense;
      const balance = income - expense;
      return `
        <div class="summary-block">
          <span class="summary-label">${cur}</span>
          <span class="summary-value">
            +${formatNumber(income)} / -${formatNumber(expense)} / =${formatNumber(balance)}
          </span>
        </div>
      `;
    }).join('');

    el.innerHTML = `
      <div class="summary-title">Summary (filtered by period)</div>
      <div class="summary-row">
        ${blocks || '<div class="summary-block"><span class="summary-label">No data</span></div>'}
      </div>
    `;
  }

  // ===== MONTHLY TABLE (ALL CARDS, SORTED BY DATE) =====
  function renderMonthlyTable() {
    const table = document.getElementById('monthly-table');
    const filtered = items
      .filter(it => passesRangeFilter(it))
      .sort((a,b) => a.date === b.date ? a.column.localeCompare(b.column) : (a.date > b.date ? 1 : -1));

    if (filtered.length === 0) {
      table.innerHTML = '<tbody><tr><td>Нет данных для выбранного периода</td></tr></tbody>';
      return;
    }

    let html = `
      <thead>
        <tr>
          <th>Date</th>
          <th>Column</th>
          <th>Category</th>
          <th>Name</th>
          <th>Type</th>
          <th>Amount</th>
          <th>Currency</th>
          <th>Payment</th>
          <th>Comment</th>
        </tr>
      </thead>
      <tbody>
    `;

    // totals per currency
    const totals = {
      KZT:{income:0,expense:0},
      USD:{income:0,expense:0}
    };

    filtered.forEach(it => {
      const symbol = currencySymbols[it.currency] || '';
      const signed = it.type === 'expense' ? -it.amount : it.amount;
      const colLabel = COLUMNS.find(c => c.key === it.column)?.label || it.column;

      html += `
        <tr>
          <td>${it.date}</td>
          <td>${colLabel}</td>
          <td>${it.category}</td>
          <td>${it.title || ''}</td>
          <td>${it.type.toUpperCase()}</td>
          <td>${symbol} ${formatNumber(signed)}</td>
          <td>${it.currency}</td>
          <td>${it.payment}</td>
          <td style="text-align:left;">${it.comment || ''}</td>
        </tr>
      `;

      const cur = it.currency || 'KZT';
      if (!totals[cur]) totals[cur] = {income:0,expense:0};
      if (it.type === 'income') totals[cur].income += it.amount;
      else totals[cur].expense += it.amount;
    });

    html += '</tbody><tfoot>';

    Object.keys(totals).forEach(cur => {
      const t = totals[cur];
      if (!t.income && !t.expense) return;
      const balance = t.income - t.expense;
      html += `
        <tr>
          <td colspan="5">TOTAL ${cur}</td>
          <td>${formatNumber(balance)}</td>
          <td>${cur}</td>
          <td colspan="2">+${formatNumber(t.income)} / -${formatNumber(t.expense)}</td>
        </tr>
      `;
    });

    html += '</tfoot>';

    table.innerHTML = html;
  }

  // ===== MONTHLY P&L =====
  function renderProfitAndLoss() {
    const container = document.getElementById('monthly-pl');
    if (!container) return;
    const filtered = items.filter(passesRangeFilter);
    container.innerHTML = '';

    if (!filtered.length) {
      container.innerHTML = '<div class="analytics-note">No data for selected period.</div>';
      return;
    }

    const currencies = Array.from(new Set(filtered.map(it => it.currency || 'KZT')));

    currencies.forEach(cur => {
      const state = createEmptyPLState();
      const curItems = filtered.filter(it => (it.currency || 'KZT') === cur);

      curItems.forEach(it => {
        const catUpper = (it.category || '').trim().toUpperCase();
        const key = mapCategoryToPLKey(catUpper);
        if (key) {
          state.rows[key] += Math.abs(it.amount);
        }
        if (catUpper === 'COMISSIONS') {
          state.commissions += Math.abs(it.amount);
        }
        if (catUpper === 'AMORTIZATION') {
          state.amortization += Math.abs(it.amount);
        }
        if (catUpper === 'TAXES') {
          state.taxes += Math.abs(it.amount);
        }
      });

      const revenueSum = PL_ROWS.filter(r=>r.group==='revenue')
        .reduce((s,r)=>s + state.rows[r.key],0);
      const cogsSum = PL_ROWS.filter(r=>r.group==='cogs')
        .reduce((s,r)=>s + state.rows[r.key],0);
      const opexSum = PL_ROWS.filter(r=>r.group==='opex')
        .reduce((s,r)=>s + state.rows[r.key],0);

      state.grossRevenue = revenueSum;
      state.vat = state.grossRevenue * 0.12; // 12% НДС автоматически
      state.totalCogs = cogsSum;
      state.netRevenue = state.grossRevenue - state.vat - state.commissions - state.totalCogs;
      state.operationalExp = opexSum;
      state.ebitda = state.netRevenue - state.operationalExp;
      state.netIncome = state.ebitda - state.amortization - state.taxes;

      const wrapper = document.createElement('div');
      wrapper.className = 'analytics-table-wrapper';

      const title = document.createElement('div');
      title.style.fontSize = '11px';
      title.style.fontWeight = '600';
      title.style.margin = '6px 0 4px';
      title.textContent = `P&L — currency: ${cur}`;
      wrapper.appendChild(title);

      let html = '<table class="analytics-table"><tbody>';

      function row(label, value, bold=false, spacer=false){
        if (spacer){
          html += '<tr><td colspan="2" style="border:none;height:4px;"></td></tr>';
        }
        const style = bold ? 'font-weight:600;' : '';
        html += `<tr><td style="text-align:left;${style}">${label}</td><td style="${style}">${formatNumber(value)}</td></tr>`;
      }

      // Revenue block
      row('Revenue by tour', state.rows.REV_TOUR);
      row('Hotel rooms', state.rows.REV_HOTEL);
      row('Cashbacks', state.rows.REV_CASHBACKS);
      row('Other revenue', state.rows.REV_OTHER);
      row('Total Gross Revenue', state.grossRevenue, true);

      row('',0,false,true);
      row('VAT 12%', state.vat);
      row('Comissions', state.commissions);

      // COGS
      row('',0,false,true);
      row('Cost of accomodation', state.rows.COGS_ACCOM);
      row('Cost of tour', state.rows.COGS_TOUR);
      row('Cost of transport', state.rows.COGS_TRANSPORT);
      row('Cost of guides', state.rows.COGS_GUIDES);
      row('Cost of servise', state.rows.COGS_SERVICE);
      row('Cost of guest expences', state.rows.COGS_GUEST_EXP);
      row('Cost of transfers', state.rows.COGS_TRANSFERS);
      row('Cost of sim cards', state.rows.COGS_SIM);
      row('Cost of gas', state.rows.COGS_GAS);
      row('Cost of carwash', state.rows.COGS_CARWASH);
      row('Cost of parking', state.rows.COGS_PARKING);
      row('Total COGS', state.totalCogs, true);

      row('',0,false,true);
      row('Net Revenue', state.netRevenue, true);

      // OPEX
      row('',0,false,true);
      row('Sales comissions', state.rows.OPEX_SALES_COMM);
      row('Office expenses', state.rows.OPEX_OFFICE);
      row('Car repair', state.rows.OPEX_CAR_REPAIR);
      row('Branding', state.rows.OPEX_BRANDING);
      row('Bloggers expenses', state.rows.OPEX_BLOGGERS);
      row('Guests lunch', state.rows.OPEX_GUEST_LUNCH);
      row('Guests souvenirs', state.rows.OPEX_GUEST_SOUV);
      row('Other spendings', state.rows.OPEX_OTHER);
      row('Salary fund', state.rows.OPEX_SALARY_FUND);
      row('Operational expenses', state.operationalExp, true);

      row('',0,false,true);
      row('EBITDA', state.ebitda, true);

      row('',0,false,true);
      row('Amortization', state.amortization);
      row('Taxes', state.taxes);
      row('Net income', state.netIncome, true);

      html += '</tbody></table>';
      wrapper.innerHTML += html;

      container.appendChild(wrapper);
    });
  }

  // ===== ANALYTICS =====
  function renderAnalytics() {
    const container = document.getElementById('analytics-tables');
    container.innerHTML = '';

    const filtered = items.filter(passesRangeFilter);
    if (filtered.length === 0) {
      container.innerHTML = '<div class="analytics-note">No data for selected period.</div>';
      return;
    }

    const dates = Array.from(new Set(filtered.map(it => it.date))).sort();
    const currencies = Array.from(new Set(filtered.map(it => it.currency || 'KZT')));

    currencies.forEach(cur => {
      const perDate = {};
      dates.forEach(d => {
        perDate[d] = { fixed:0, variable:0, additional:0, guest:0, total:0 };
      });

      filtered
        .filter(it => (it.currency || 'KZT') === cur)
        .forEach(it => {
          const d = it.date;
          if (!perDate[d]) perDate[d] = { fixed:0, variable:0, additional:0, guest:0, total:0 };
          const sign = it.type === 'expense' ? -1 : 1;
          const amt = sign * it.amount;
          if (perDate[d][it.column] !== undefined) {
            perDate[d][it.column] += amt;
          }
          perDate[d].total += amt;
        });

      let sumFixed=0,sumVar=0,sumAdd=0,sumGuest=0,sumTotal=0;
      dates.forEach(d => {
        const r = perDate[d];
        sumFixed += r.fixed;
        sumVar += r.variable;
        sumAdd += r.additional;
        sumGuest += r.guest;
        sumTotal += r.total;
      });

      const wrap = document.createElement('div');
      wrap.className = 'analytics-table-wrapper';
      const title = document.createElement('div');
      title.style.fontSize = '11px';
      title.style.fontWeight = '600';
      title.style.marginBottom = '4px';
      title.textContent = `Currency: ${cur}`;
      wrap.appendChild(title);

      const table = document.createElement('table');
      table.className = 'analytics-table';

      let html = `
        <thead>
          <tr>
            <th>Date</th>
            <th>Fixed</th>
            <th>Variable</th>
            <th>Additional</th>
            <th>Guest</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody>
      `;

      dates.forEach(d => {
        const r = perDate[d];
        html += `
          <tr>
            <td>${d}</td>
            <td>${formatNumber(r.fixed)}</td>
            <td>${formatNumber(r.variable)}</td>
            <td>${formatNumber(r.additional)}</td>
            <td>${formatNumber(r.guest)}</td>
            <td>${formatNumber(r.total)}</td>
          </tr>
        `;
      });

      html += `
        </tbody>
        <tfoot>
          <tr>
            <td>Total</td>
            <td>${formatNumber(sumFixed)}</td>
            <td>${formatNumber(sumVar)}</td>
            <td>${formatNumber(sumAdd)}</td>
            <td>${formatNumber(sumGuest)}</td>
            <td>${formatNumber(sumTotal)}</td>
          </tr>
        </tfoot>
      `;

      table.innerHTML = html;
      wrap.appendChild(table);
      container.appendChild(wrap);
    });
  }

  // ===== MODAL =====
  const modalBackdrop = document.getElementById('card-modal-backdrop');
  const modalTitleEl = document.getElementById('modal-title');
  const modalErrorEl = document.getElementById('modal-error');
  const formEl = document.getElementById('card-form');

  const fieldId = document.getElementById('field-id');
  const fieldColumn = document.getElementById('field-column');
  const fieldColumnName = document.getElementById('field-column-name');
  const fieldMode = document.getElementById('field-mode');

  const fieldCategory = document.getElementById('field-category');
  const fieldTitle = document.getElementById('field-title');
  const fieldAmount = document.getElementById('field-amount');
  const fieldCurrency = document.getElementById('field-currency');
  const fieldPayment = document.getElementById('field-payment');
  const fieldType = document.getElementById('field-type');
  const fieldDate = document.getElementById('field-date');
  const fieldComment = document.getElementById('field-comment');

  function populateCategoryOptions(columnKey, currentCategory) {
    const opts = CATEGORY_OPTIONS[columnKey] || [];
    fieldCategory.innerHTML = '';
    opts.forEach(cat => {
      const opt = document.createElement('option');
      opt.value = cat;
      opt.textContent = cat;
      fieldCategory.appendChild(opt);
    });
    if (currentCategory && !opts.includes(currentCategory)) {
      const opt = document.createElement('option');
      opt.value = currentCategory;
      opt.textContent = currentCategory + ' (custom)';
      fieldCategory.appendChild(opt);
    }
    fieldCategory.value = currentCategory || opts[0] || '';
    fieldTitle.value = fieldCategory.value;
  }

  fieldCategory.addEventListener('change', () => {
    if (!fieldTitle.value || fieldTitle.value === fieldCategory.value) {
      fieldTitle.value = fieldCategory.value;
    }
  });

  function openModal(mode, columnKey, item) {
    fieldMode.value = mode;
    fieldColumn.value = columnKey;
    fieldColumnName.value = COLUMNS.find(c => c.key === columnKey)?.label || columnKey;
    modalErrorEl.textContent = '';

    if (mode === 'add') {
      modalTitleEl.textContent = 'Add item';
      fieldId.value = '';
      populateCategoryOptions(columnKey, null);
      fieldAmount.value = '';
      fieldCurrency.value = 'KZT';
      fieldPayment.value = 'kaspi';
      fieldType.value = 'expense';
      fieldDate.value = todayDateString();
      fieldComment.value = '';
    } else if (mode === 'edit' && item) {
      modalTitleEl.textContent = 'Edit item';
      fieldId.value = item.id;
      populateCategoryOptions(columnKey, item.category);
      fieldTitle.value = item.title || item.category;
      fieldAmount.value = item.amount;
      fieldCurrency.value = item.currency;
      fieldPayment.value = item.payment;
      fieldType.value = item.type;
      fieldDate.value = item.date;
      fieldComment.value = item.comment || '';
    }

    modalBackdrop.classList.remove('modal-hidden');
  }

  function closeModal() {
    modalBackdrop.classList.add('modal-hidden');
  }

  formEl.addEventListener('submit', (e) => {
    e.preventDefault();
    modalErrorEl.textContent = '';

    const mode = fieldMode.value;
    const columnKey = fieldColumn.value;

    const category = fieldCategory.value.trim();
    const title = (fieldTitle.value || category).trim();
    const amount = parseFloat(fieldAmount.value);
    const currency = fieldCurrency.value || 'KZT';
    const payment = fieldPayment.value || 'other';
    const type = fieldType.value === 'income' ? 'income' : 'expense';
    const date = fieldDate.value;
    const comment = fieldComment.value.trim();

    if (!category) {
      modalErrorEl.textContent = 'Category is required.';
      return;
    }
    if (!amount || amount <= 0) {
      modalErrorEl.textContent = 'Amount must be positive.';
      return;
    }
    if (!date || !parseDate(date)) {
      modalErrorEl.textContent = 'Valid date is required.';
      return;
    }

    if (mode === 'add') {
      items.push({
        id: generateId(),
        column: columnKey,
        category,
        title,
        amount,
        currency,
        payment,
        type,
        date,
        comment
      });
    } else {
      const id = fieldId.value;
      const item = items.find(it => it.id === id);
      if (!item) {
        modalErrorEl.textContent = 'Item not found.';
        return;
      }
      Object.assign(item, {
        column: columnKey,
        category,
        title,
        amount,
        currency,
        payment,
        type,
        date,
        comment
      });
    }

    saveData();
    closeModal();
    refresh();
  });

  document.getElementById('modal-close-btn').addEventListener('click', closeModal);
  document.getElementById('modal-cancel-btn').addEventListener('click', closeModal);
  modalBackdrop.addEventListener('click', (e) => {
    if (e.target === modalBackdrop) closeModal();
  });

  // ===== ADD / EDIT / DELETE HANDLERS =====
  function handleAdd(columnKey) {
    openModal('add', columnKey, null);
  }

  function handleEdit(id) {
    const item = items.find(it => it.id === id);
    if (!item) return;
    openModal('edit', item.column, item);
  }

  function handleDelete(id) {
    const item = items.find(it => it.id === id);
    if (!item) return;
    if (!confirm('Delete this item?')) return;
    items = items.filter(it => it.id !== id);
    saveData();
    refresh();
  }

  // ===== DRAG & DROP =====
  function handleDragStart(e) {
    const card = e.currentTarget;
    dragItemId = card.dataset.itemId;
    card.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
  }

  function handleDragEnd(e) {
    e.currentTarget.classList.remove('dragging');
    dragItemId = null;
    document.querySelectorAll('.column-body').forEach(el => el.classList.remove('drop-target'));
  }

  function setupDragDrop() {
    document.querySelectorAll('.column-body').forEach(body => {
      body.addEventListener('dragover', e => {
        if (!dragItemId) return;
        e.preventDefault();
        body.classList.add('drop-target');
      });
      body.addEventListener('dragleave', () => {
        body.classList.remove('drop-target');
      });
      body.addEventListener('drop', e => {
        if (!dragItemId) return;
        e.preventDefault();
        body.classList.remove('drop-target');
        const item = items.find(it => it.id === dragItemId);
        if (!item) return;
        const newColumn = body.dataset.dropColumn;
        if (!newColumn) return;
        item.column = newColumn;
        saveData();
        refresh();
      });
    });
  }

  // ===== FILTERS & TABS =====
  function setupFilters() {
    const filterSelect = document.getElementById('filter-mode');
    const customRange = document.getElementById('custom-range');
    const dateFrom = document.getElementById('date-from');
    const dateTo = document.getElementById('date-to');

    filterSelect.addEventListener('change', () => {
      filterMode = filterSelect.value;
      if (filterMode === 'custom') {
        customRange.style.display = '';
        if (!customFrom) customFrom = todayDateString();
        if (!customTo) customTo = todayDateString();
        dateFrom.value = customFrom;
        dateTo.value = customTo;
      } else {
        customRange.style.display = 'none';
      }
      dailySelectedDate = 'all';
      refresh();
    });

    dateFrom.addEventListener('change', () => {
      customFrom = dateFrom.value || null;
      dailySelectedDate = 'all';
      refresh();
    });
    dateTo.addEventListener('change', () => {
      customTo = dateTo.value || null;
      dailySelectedDate = 'all';
      refresh();
    });
  }

  function setupTabs() {
    const buttons = document.querySelectorAll('.tab-btn');
    buttons.forEach(btn => {
      btn.addEventListener('click', () => {
        buttons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        activeView = btn.dataset.view;

        document.getElementById('board-daily').classList.toggle('hidden', activeView !== 'daily');
        document.getElementById('board-monthly').classList.toggle('hidden', activeView !== 'monthly');
        document.getElementById('analytics-page').classList.toggle('hidden', activeView !== 'analytics');

        if (activeView === 'monthly') {
          renderMonthlyTable();
          renderProfitAndLoss();
        }
        if (activeView === 'analytics') renderAnalytics();
      });
    });
  }

  function setupGlobalClicks() {
    document.addEventListener('click', e => {
      const btn = e.target.closest('button');
      if (!btn) return;

      // date tabs
      if (btn.classList.contains('date-tab')) {
        const d = btn.dataset.date;
        dailySelectedDate = d || 'all';
        refresh();
        return;
      }

      // month tabs
      if (btn.classList.contains('month-tab')) {
        const key = btn.dataset.monthKey;
        if (key) {
          const [yearStr, monthStr] = key.split('-');
          const year = parseInt(yearStr,10);
          const monthIndex = parseInt(monthStr,10) - 1;
          const fromStr = `${year}-${monthStr}-01`;
          const lastDay = new Date(year, monthIndex + 1, 0).getDate();
          const toStr = `${year}-${monthStr}-${String(lastDay).padStart(2,'0')}`;

          filterMode = 'custom';
          customFrom = fromStr;
          customTo = toStr;

          const filterSelect = document.getElementById('filter-mode');
          filterSelect.value = 'custom';
          document.getElementById('custom-range').style.display = '';
          document.getElementById('date-from').value = customFrom;
          document.getElementById('date-to').value = customTo;

          dailySelectedDate = 'all';
          refresh();
        }
        return;
      }

      const action = btn.dataset.action;
      if (action === 'add') {
        const columnKey = btn.dataset.column;
        handleAdd(columnKey);
      } else if (action === 'edit') {
        handleEdit(btn.dataset.itemId);
      } else if (action === 'delete') {
        handleDelete(btn.dataset.itemId);
      }
    });
  }

  // ===== MAIN REFRESH =====
  function refresh() {
    renderDailyDateTabs();
    renderMonthlyMonthTabs();
    renderDaily();
    renderSummary();
    if (activeView === 'monthly') {
      renderMonthlyTable();
      renderProfitAndLoss();
    }
    if (activeView === 'analytics') {
      renderAnalytics();
    }
    setupDragDrop();
  }

  // ===== INIT =====
  loadData();
  setupFilters();
  setupTabs();
  setupGlobalClicks();
  refresh();
</script>
</body>
</html>
