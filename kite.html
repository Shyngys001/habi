<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Finance Kanban</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      --bg-page:#f5f5f7;
      --bg-header:#ffffff;
      --bg-column:#ffffff;
      --bg-card:#f9fafb;
      --border-soft:#e5e7eb;
      --border-strong:#d1d5db;
      --text-main:#111827;
      --text-muted:#6b7280;
      --accent:#2563eb;
      --accent-soft:#eff6ff;
      --danger:#b91c1c;
      --radius-lg:14px;
      --radius-md:10px;
      --shadow-soft:0 10px 25px rgba(15,23,42,0.08);
      --shadow-card:0 4px 10px rgba(15,23,42,0.06);
    }

    *{box-sizing:border-box;}

    body{
      margin:0;
      font-family:"Inter",system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
      background:var(--bg-page);
      color:var(--text-main);
    }

    .app{
      max-width:1200px;
      margin:0 auto;
      padding:16px 12px 24px;
    }

    header{
      background:var(--bg-header);
      border-radius:18px;
      padding:14px 16px;
      box-shadow:var(--shadow-soft);
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      align-items:center;
      margin-bottom:16px;
      border:1px solid #e5e7eb;
    }

    .title-block{
      flex:1;
      min-width:220px;
    }

    h1{
      margin:0;
      font-size:20px;
      font-weight:600;
      letter-spacing:0.08em;
      text-transform:uppercase;
    }

    .subtitle{
      margin-top:4px;
      font-size:12px;
      color:var(--text-muted);
    }

    .top-controls{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }

    .tab-buttons{
      display:flex;
      background:#f3f4f6;
      border-radius:999px;
      padding:3px;
      border:1px solid #e5e7eb;
    }
    .tab-btn{
      border:none;
      background:transparent;
      padding:6px 14px;
      border-radius:999px;
      font-size:13px;
      cursor:pointer;
      color:var(--text-muted);
      display:flex;
      align-items:center;
      gap:6px;
    }
    .tab-btn span.dot{
      width:6px;
      height:6px;
      border-radius:999px;
      background:#9ca3af;
    }
    .tab-btn.active{
      background:#111827;
      color:#f9fafb;
      font-weight:500;
    }
    .tab-btn.active span.dot{
      background:#f9fafb;
    }

    .filters{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
      font-size:12px;
    }
    select,input[type="date"]{
      font-family:inherit;
      font-size:12px;
      padding:5px 8px;
      border-radius:8px;
      border:1px solid #d1d5db;
      background:#ffffff;
      color:var(--text-main);
      outline:none;
    }
    select:focus,input[type="date"]:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 1px var(--accent-soft);
    }

    main{
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    .board{
      background:#f9fafb;
      border-radius:18px;
      padding:12px;
      box-shadow:var(--shadow-soft);
      border:1px solid #e5e7eb;
    }

    .board.hidden{display:none;}

    .board-header{
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:0.14em;
      color:var(--text-muted);
      margin-bottom:6px;
    }

    .columns{
      display:flex;
      gap:12px;
      overflow-x:auto;
      padding-bottom:6px;
    }

    .column{
      background:var(--bg-column);
      border-radius:var(--radius-lg);
      min-width:220px;
      max-width:260px;
      flex:1;
      border:1px solid var(--border-soft);
      box-shadow:var(--shadow-soft);
      display:flex;
      flex-direction:column;
      max-height:70vh;
    }

    .column-header{
      padding:10px 10px 6px;
      border-bottom:1px solid #e5e7eb;
    }
    .column-title-row{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap:6px;
    }
    .column-title{
      font-size:12px;
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:0.14em;
    }
    .column-total{
      font-size:11px;
      color:var(--text-muted);
      text-align:right;
      margin-top:4px;
      min-height:14px;
    }

    .add-btn{
      margin:6px 10px 8px;
      font-size:11px;
      padding:5px 9px;
      border-radius:999px;
      border:1px dashed var(--border-strong);
      background:#f9fafb;
      color:var(--text-muted);
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .add-btn span.plus{
      font-size:16px;
      line-height:0;
      color:var(--accent);
    }
    .add-btn:hover{
      background:#eff6ff;
      border-style:solid;
    }

    .column-body{
      padding:0 8px 8px;
      overflow-y:auto;
      flex:1;
    }

    .card{
      background:var(--bg-card);
      border-radius:var(--radius-md);
      border:1px solid var(--border-soft);
      padding:8px 8px 6px;
      margin-bottom:6px;
      box-shadow:var(--shadow-card);
      cursor:grab;
    }
    .card.dragging{
      opacity:0.6;
      box-shadow:0 0 0 2px var(--accent-soft);
    }

    .card-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:6px;
      margin-bottom:4px;
    }
    .card-title{
      font-size:12px;
      font-weight:500;
      word-break:break-word;
    }
    .card-meta{
      display:flex;
      gap:4px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .pill{
      padding:2px 6px;
      border-radius:999px;
      font-size:10px;
      border:1px solid #e5e7eb;
      background:#f3f4f6;
      color:var(--text-muted);
      white-space:nowrap;
    }
    .pill.type-income{border-color:#bbf7d0;background:#ecfdf3;color:#166534;}
    .pill.type-expense{border-color:#fecaca;background:#fef2f2;color:#991b1b;}

    .card-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
      font-size:11px;
      margin-bottom:2px;
    }
    .amount-block{
      display:flex;
      align-items:center;
      gap:4px;
      font-variant-numeric:tabular-nums;
    }
    .amount{
      font-weight:600;
    }
    .comment{
      flex:1;
      text-align:right;
      color:var(--text-muted);
      font-style:italic;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    .card-footer{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:4px;
      font-size:10px;
      color:var(--text-muted);
    }

    .card-actions{
      display:flex;
      gap:6px;
    }
    .icon-btn{
      border:none;
      background:transparent;
      padding:0;
      font-size:11px;
      cursor:pointer;
      color:var(--text-muted);
    }
    .icon-btn:hover{
      color:var(--accent);
    }
    .icon-btn.delete:hover{
      color:var(--danger);
    }

    .drop-target{
      border:1px dashed var(--accent);
    }

    .summary{
      background:#ffffff;
      border-radius:16px;
      padding:10px 12px;
      box-shadow:var(--shadow-soft);
      border:1px solid #e5e7eb;
      font-size:11px;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .summary-title{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.14em;
      color:var(--text-muted);
      margin-bottom:2px;
    }
    .summary-row{
      display:flex;
      flex-wrap:wrap;
      justify-content:space-between;
      gap:4px;
    }
    .summary-block{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
    }
    .summary-label{
      font-weight:500;
    }
    .summary-value{
      font-variant-numeric:tabular-nums;
    }

    @media (max-width:768px){
      header{
        flex-direction:column;
        align-items:flex-start;
      }
      .top-controls{
        width:100%;
        justify-content:space-between;
      }
      .columns{
        max-height:none;
      }
      .column{
        max-height:none;
      }
    }

    /* ===== MODAL ===== */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(15,23,42,0.45);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:50;
    }
    .modal-hidden{
      display:none;
    }
    .modal{
      background:#ffffff;
      border-radius:18px;
      padding:16px 18px 14px;
      width:100%;
      max-width:420px;
      box-shadow:0 20px 40px rgba(15,23,42,0.35);
      border:1px solid #e5e7eb;
    }
    .modal-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:10px;
    }
    .modal-title{
      font-size:14px;
      font-weight:600;
    }
    .modal-close{
      border:none;
      background:transparent;
      font-size:18px;
      line-height:1;
      cursor:pointer;
      color:var(--text-muted);
    }
    .modal-close:hover{
      color:var(--text-main);
    }
    .modal-form{
      display:flex;
      flex-direction:column;
      gap:8px;
      font-size:12px;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:3px;
    }
    .field-row{
      display:flex;
      gap:8px;
    }
    .field label{
      font-size:11px;
      color:var(--text-muted);
    }
    .field input,
    .field select,
    .field textarea{
      font-family:inherit;
      font-size:12px;
      padding:6px 8px;
      border-radius:8px;
      border:1px solid #d1d5db;
      outline:none;
      background:#ffffff;
    }
    .field textarea{
      resize:vertical;
      min-height:50px;
    }
    .field input:focus,
    .field select:focus,
    .field textarea:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 1px var(--accent-soft);
    }
    .modal-error{
      font-size:11px;
      color:var(--danger);
      min-height:14px;
    }
    .modal-footer{
      margin-top:6px;
      display:flex;
      justify-content:flex-end;
      gap:8px;
    }
    .btn{
      border:none;
      border-radius:999px;
      font-size:12px;
      padding:6px 14px;
      cursor:pointer;
      font-weight:500;
    }
    .btn-secondary{
      background:#e5e7eb;
      color:#111827;
    }
    .btn-secondary:hover{
      background:#d1d5db;
    }
    .btn-primary{
      background:#111827;
      color:#f9fafb;
    }
    .btn-primary:hover{
      background:#020617;
    }
  </style>
</head>
<body>
<div class="app">
  <header>
    <div class="title-block">
      <h1>Finance Kanban</h1>
      <div class="subtitle">
        Daily & Monthly expenses / income with dates, comments, payment method and currency. Drag cards, everything saved in your browser.
      </div>
    </div>
    <div class="top-controls">
      <div class="tab-buttons">
        <button class="tab-btn active" data-board="daily">
          <span class="dot"></span>Daily
        </button>
        <button class="tab-btn" data-board="monthly">
          <span class="dot"></span>Monthly
        </button>
      </div>
      <div class="filters">
        <span>Period:</span>
        <select id="filter-mode">
          <option value="today">Today</option>
          <option value="thisWeek">This week</option>
          <option value="thisMonth" selected>This month</option>
          <option value="custom">Custom</option>
        </select>
        <span id="custom-range" style="display:none;">
          From <input type="date" id="date-from">
          To <input type="date" id="date-to">
        </span>
      </div>
    </div>
  </header>

  <main>
    <!-- DAILY BOARD -->
    <section class="board" id="board-daily">
      <div class="board-header">Daily board</div>
      <div class="columns" id="columns-daily"></div>
    </section>

    <!-- MONTHLY BOARD -->
    <section class="board hidden" id="board-monthly">
      <div class="board-header">Monthly board</div>
      <div class="columns" id="columns-monthly"></div>
    </section>

    <!-- SUMMARY -->
    <section class="summary" id="summary"></section>
  </main>
</div>

<!-- MODAL: ADD / EDIT CARD -->
<div id="card-modal-backdrop" class="modal-backdrop modal-hidden">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="modal-title">Add item</div>
      <button class="modal-close" type="button" id="modal-close-btn">&times;</button>
    </div>
    <form id="card-form" class="modal-form">
      <div class="field">
        <label for="field-title">Title / Category *</label>
        <input id="field-title" type="text" required>
      </div>

      <div class="field-row">
        <div class="field" style="flex:1;">
          <label for="field-amount">Amount *</label>
          <input id="field-amount" type="number" min="0" step="0.01" required>
        </div>
        <div class="field" style="width:90px;">
          <label for="field-currency">Currency *</label>
          <select id="field-currency">
            <option value="KZT">KZT</option>
            <option value="USD">USD</option>
          </select>
        </div>
      </div>

      <div class="field-row">
        <div class="field" style="flex:1;">
          <label for="field-payment">Payment method *</label>
          <select id="field-payment">
            <option value="cash">Cash</option>
            <option value="kaspi">Kaspi</option>
            <option value="halyk">Halyk</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div class="field" style="flex:1;">
          <label for="field-type">Type *</label>
          <select id="field-type">
            <option value="expense">Expense</option>
            <option value="income">Income</option>
          </select>
        </div>
      </div>

      <div class="field">
        <label for="field-date">Date (YYYY-MM-DD) *</label>
        <input id="field-date" type="date" required>
      </div>

      <div class="field">
        <label for="field-comment">Comment</label>
        <textarea id="field-comment" placeholder="Short note about this item"></textarea>
      </div>

      <div class="modal-error" id="modal-error"></div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" id="modal-cancel-btn">Cancel</button>
        <button type="submit" class="btn btn-primary">Save</button>
      </div>

      <!-- hidden context -->
      <input type="hidden" id="field-id">
      <input type="hidden" id="field-board">
      <input type="hidden" id="field-column">
      <input type="hidden" id="field-mode">
    </form>
  </div>
</div>

<script>
  // ===== CONFIG =====
  const STORAGE_KEY = 'finance_kanban_items_v1';

  const DAILY_COLUMNS = [
    { key: 'fixed', label: 'Fixed' },
    { key: 'variable', label: 'Variable' },
    { key: 'additional', label: 'Additional' },
    { key: 'guest', label: 'Guest' },
  ];

  const MONTHLY_COLUMNS = [
    { key: 'income', label: 'Income' },
    { key: 'tour', label: 'Tour Costs' },
    { key: 'other', label: 'Other Expenses' },
  ];

  const currencySymbols = {
    KZT: '₸',
    USD: '$'
  };

  // ===== STATE =====
  let items = [];
  let filterMode = 'thisMonth';
  let customFrom = null;
  let customTo = null;
  let activeBoard = 'daily';
  let dragItemId = null;

  // ===== UTIL =====
  function generateId() {
    return 'id-' + Date.now().toString(36) + '-' + Math.random().toString(36).slice(2,8);
  }

  function parseDate(str) {
    if (!str) return null;
    const [y, m, d] = str.split('-').map(Number);
    if (!y || !m || !d) return null;
    return new Date(y, m - 1, d);
  }

  function formatNumber(num) {
    if (isNaN(num)) return '0';
    return num.toLocaleString('ru-RU', { maximumFractionDigits: 2 });
  }

  function todayDateString() {
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth() + 1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  }

  function startOfDay(d) {
    const x = new Date(d);
    x.setHours(0,0,0,0);
    return x;
  }

  function endOfDay(d) {
    const x = new Date(d);
    x.setHours(23,59,59,999);
    return x;
  }

  function getFilterRange() {
    const now = new Date();
    const today = startOfDay(now);
    let from, to;

    if (filterMode === 'today') {
      from = today;
      to = endOfDay(today);
    } else if (filterMode === 'thisWeek') {
      const day = today.getDay();
      const diff = (day + 6) % 7; // Monday start
      from = new Date(today);
      from.setDate(from.getDate() - diff);
      to = new Date(from);
      to.setDate(to.getDate() + 6);
      to = endOfDay(to);
    } else if (filterMode === 'thisMonth') {
      from = new Date(today.getFullYear(), today.getMonth(), 1);
      to = endOfDay(new Date(today.getFullYear(), today.getMonth() + 1, 0));
    } else if (filterMode === 'custom') {
      if (!customFrom || !customTo) return null;
      const f = parseDate(customFrom);
      const t = parseDate(customTo);
      if (!f || !t) return null;
      from = startOfDay(f);
      to = endOfDay(t);
    } else {
      return null;
    }

    return { from, to };
  }

  function passesFilter(item) {
    const range = getFilterRange();
    if (!range) return true;
    const d = parseDate(item.date);
    if (!d) return false;
    return d >= range.from && d <= range.to;
  }

  // ===== STORAGE =====
  function loadData() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) {
        items = [];
        seedDemoData();
        saveData();
      } else {
        items = JSON.parse(raw);
      }
    } catch (e) {
      console.error('Failed to load data', e);
      items = [];
      seedDemoData();
      saveData();
    }
  }

  function saveData() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
  }

  function seedDemoData() {
    const today = todayDateString();
    items = [
      {
        id: generateId(),
        board: 'daily',
        column: 'fixed',
        title: 'Rent',
        amount: 120000,
        currency: 'KZT',
        paymentMethod: 'kaspi',
        type: 'expense',
        date: today,
        comment: 'Офис'
      },
      {
        id: generateId(),
        board: 'daily',
        column: 'variable',
        title: 'Guest lunch',
        amount: 18000,
        currency: 'KZT',
        paymentMethod: 'cash',
        type: 'expense',
        date: today,
        comment: 'Обед с туристами'
      },
      {
        id: generateId(),
        board: 'daily',
        column: 'additional',
        title: 'Blog ads',
        amount: 120,
        currency: 'USD',
        paymentMethod: 'other',
        type: 'expense',
        date: today,
        comment: 'Instagram promo'
      },
      {
        id: generateId(),
        board: 'monthly',
        column: 'income',
        title: 'Tour revenue',
        amount: 2500000,
        currency: 'KZT',
        paymentMethod: 'kaspi',
        type: 'income',
        date: today,
        comment: 'Group tour Jan'
      },
      {
        id: generateId(),
        board: 'monthly',
        column: 'tour',
        title: 'Hotel costs',
        amount: 800000,
        currency: 'KZT',
        paymentMethod: 'halyk',
        type: 'expense',
        date: today,
        comment: 'Hotel Shymbulak'
      }
    ];
  }

  // ===== RENDERING =====
  function renderBoard(board) {
    const columnsDef = board === 'daily' ? DAILY_COLUMNS : MONTHLY_COLUMNS;
    const container = document.getElementById(board === 'daily' ? 'columns-daily' : 'columns-monthly');
    container.innerHTML = '';

    columnsDef.forEach(col => {
      const colDiv = document.createElement('div');
      colDiv.className = 'column';
      colDiv.dataset.board = board;
      colDiv.dataset.column = col.key;

      const header = document.createElement('div');
      header.className = 'column-header';
      const titleRow = document.createElement('div');
      titleRow.className = 'column-title-row';

      const title = document.createElement('div');
      title.className = 'column-title';
      title.textContent = col.label;

      const headerRight = document.createElement('div');
      headerRight.style.fontSize = '10px';
      headerRight.style.color = 'var(--text-muted)';
      headerRight.textContent = board === 'daily' ? 'per day' : 'per month';

      titleRow.appendChild(title);
      titleRow.appendChild(headerRight);
      header.appendChild(titleRow);

      const total = document.createElement('div');
      total.className = 'column-total';
      total.dataset.role = 'column-total';
      header.appendChild(total);

      colDiv.appendChild(header);

      const addBtn = document.createElement('button');
      addBtn.className = 'add-btn';
      addBtn.dataset.action = 'add';
      addBtn.dataset.board = board;
      addBtn.dataset.column = col.key;
      addBtn.innerHTML = `<span class="plus">+</span> Add expense`;
      colDiv.appendChild(addBtn);

      const body = document.createElement('div');
      body.className = 'column-body';
      body.dataset.dropColumn = col.key;
      body.dataset.board = board;

      const colItems = items.filter(
        it => it.board === board && it.column === col.key && passesFilter(it)
      );

      colItems.forEach(it => {
        const card = buildCard(it);
        body.appendChild(card);
      });

      colDiv.appendChild(body);

      container.appendChild(colDiv);

      const totals = calcColumnTotals(board, col.key);
      total.textContent = formatColumnTotalsLabel(totals);
    });
  }

  function buildCard(item) {
    const card = document.createElement('div');
    card.className = 'card';
    card.draggable = true;
    card.dataset.itemId = item.id;

    const cardHeader = document.createElement('div');
    cardHeader.className = 'card-header';

    const title = document.createElement('div');
    title.className = 'card-title';
    title.textContent = item.title;

    const meta = document.createElement('div');
    meta.className = 'card-meta';

    const typePill = document.createElement('div');
    typePill.className = 'pill ' + (item.type === 'income' ? 'type-income' : 'type-expense');
    typePill.textContent = item.type === 'income' ? 'INCOME' : 'EXPENSE';

    const payPill = document.createElement('div');
    payPill.className = 'pill';
    const pm = item.paymentMethod || 'other';
    payPill.textContent =
      pm === 'cash' ? 'Cash' :
      pm === 'kaspi' ? 'Kaspi' :
      pm === 'halyk' ? 'Halyk' : 'Other';

    const curPill = document.createElement('div');
    curPill.className = 'pill';
    curPill.textContent = item.currency;

    meta.appendChild(typePill);
    meta.appendChild(payPill);
    meta.appendChild(curPill);

    cardHeader.appendChild(title);
    cardHeader.appendChild(meta);
    card.appendChild(cardHeader);

    const rowAmount = document.createElement('div');
    rowAmount.className = 'card-row';
    const amountBlock = document.createElement('div');
    amountBlock.className = 'amount-block';

    const symbol = currencySymbols[item.currency] || '';
    const amountSpan = document.createElement('span');
    amountSpan.className = 'amount';
    const signed = item.type === 'expense' ? -item.amount : item.amount;
    amountSpan.textContent = `${symbol} ${formatNumber(signed)}`;

    amountBlock.appendChild(amountSpan);

    const commentSpan = document.createElement('div');
    commentSpan.className = 'comment';
    commentSpan.textContent = item.comment || '';

    rowAmount.appendChild(amountBlock);
    rowAmount.appendChild(commentSpan);
    card.appendChild(rowAmount);

    const rowDate = document.createElement('div');
    rowDate.className = 'card-row';
    const dateLabel = document.createElement('span');
    dateLabel.style.fontSize = '10px';
    dateLabel.textContent = item.date;
    rowDate.appendChild(dateLabel);
    rowDate.appendChild(document.createElement('span'));
    card.appendChild(rowDate);

    const footer = document.createElement('div');
    footer.className = 'card-footer';

    const idSpan = document.createElement('span');
    idSpan.textContent = item.board === 'daily' ? 'Daily item' : 'Monthly item';

    const actions = document.createElement('div');
    actions.className = 'card-actions';

    const editBtn = document.createElement('button');
    editBtn.className = 'icon-btn edit';
    editBtn.dataset.action = 'edit';
    editBtn.dataset.itemId = item.id;
    editBtn.textContent = 'Edit';

    const delBtn = document.createElement('button');
    delBtn.className = 'icon-btn delete';
    delBtn.dataset.action = 'delete';
    delBtn.dataset.itemId = item.id;
    delBtn.textContent = 'Delete';

    actions.appendChild(editBtn);
    actions.appendChild(delBtn);

    footer.appendChild(idSpan);
    footer.appendChild(actions);

    card.appendChild(footer);

    card.addEventListener('dragstart', handleDragStart);
    card.addEventListener('dragend', handleDragEnd);

    return card;
  }

  // ===== TOTALS & SUMMARY =====
  function calcColumnTotals(board, column) {
    const result = {
      KZT: { income:0, expense:0 },
      USD: { income:0, expense:0 }
    };
    items.forEach(it => {
      if (it.board !== board || it.column !== column) return;
      if (!passesFilter(it)) return;
      const cur = it.currency || 'KZT';
      if (!result[cur]) result[cur] = { income:0, expense:0 };
      if (it.type === 'income') {
        result[cur].income += it.amount;
      } else {
        result[cur].expense += it.amount;
      }
    });
    return result;
  }

  function formatColumnTotalsLabel(totals) {
    const parts = [];
    Object.keys(totals).forEach(cur => {
      const t = totals[cur];
      const net = t.income - t.expense;
      if (t.income === 0 && t.expense === 0) return;
      parts.push(`${cur} ${formatNumber(net)}`);
    });
    return parts.join(' • ');
  }

  function calcBoardTotals(board) {
    const result = {
      KZT: { income:0, expense:0 },
      USD: { income:0, expense:0 }
    };
    items.forEach(it => {
      if (it.board !== board) return;
      if (!passesFilter(it)) return;
      const cur = it.currency || 'KZT';
      if (!result[cur]) result[cur] = { income:0, expense:0 };
      if (it.type === 'income') {
        result[cur].income += it.amount;
      } else {
        result[cur].expense += it.amount;
      }
    });
    return result;
  }

  function renderSummary() {
    const dailyTotals = calcBoardTotals('daily');
    const monthlyTotals = calcBoardTotals('monthly');
    const summaryEl = document.getElementById('summary');

    function blockHtml(label, totals) {
      const currencies = Object.keys(totals).filter(cur => totals[cur].income || totals[cur].expense);
      if (currencies.length === 0) {
        return `<div class="summary-block"><span class="summary-label">${label}</span><span class="summary-value">—</span></div>`;
      }
      const parts = currencies.map(cur => {
        const t = totals[cur];
        const income = t.income;
        const expense = t.expense;
        const balance = income - expense;
        return `${cur}: +${formatNumber(income)} / -${formatNumber(expense)} / =${formatNumber(balance)}`;
      });
      return `<div class="summary-block"><span class="summary-label">${label}</span><span class="summary-value">${parts.join(' • ')}</span></div>`;
    }

    summaryEl.innerHTML = `
      <div class="summary-title">Summary (filtered by period)</div>
      <div class="summary-row">
        ${blockHtml('Daily', dailyTotals)}
      </div>
      <div class="summary-row">
        ${blockHtml('Monthly', monthlyTotals)}
      </div>
    `;
  }

  // ===== MODAL HELPERS =====
  const modalBackdrop = document.getElementById('card-modal-backdrop');
  const modalTitleEl = document.getElementById('modal-title');
  const modalErrorEl = document.getElementById('modal-error');
  const formEl = document.getElementById('card-form');

  const fieldId = document.getElementById('field-id');
  const fieldBoard = document.getElementById('field-board');
  const fieldColumn = document.getElementById('field-column');
  const fieldMode = document.getElementById('field-mode');

  const fieldTitle = document.getElementById('field-title');
  const fieldAmount = document.getElementById('field-amount');
  const fieldCurrency = document.getElementById('field-currency');
  const fieldPayment = document.getElementById('field-payment');
  const fieldType = document.getElementById('field-type');
  const fieldDate = document.getElementById('field-date');
  const fieldComment = document.getElementById('field-comment');

  function openCardModal(mode, { board, column, item }) {
    fieldMode.value = mode;
    modalErrorEl.textContent = '';

    if (mode === 'add') {
      modalTitleEl.textContent = 'Add item';
      fieldId.value = '';
      fieldBoard.value = board;
      fieldColumn.value = column;

      fieldTitle.value = '';
      fieldAmount.value = '';
      fieldCurrency.value = 'KZT';
      fieldPayment.value = 'kaspi';

      let defaultType = 'expense';
      if (board === 'monthly' && column === 'income') defaultType = 'income';
      fieldType.value = defaultType;

      fieldDate.value = todayDateString();
      fieldComment.value = '';
    } else if (mode === 'edit' && item) {
      modalTitleEl.textContent = 'Edit item';
      fieldId.value = item.id;
      fieldBoard.value = item.board;
      fieldColumn.value = item.column;

      fieldTitle.value = item.title || '';
      fieldAmount.value = item.amount != null ? item.amount : '';
      fieldCurrency.value = item.currency || 'KZT';
      fieldPayment.value = item.paymentMethod || 'other';
      fieldType.value = item.type || 'expense';
      fieldDate.value = item.date || todayDateString();
      fieldComment.value = item.comment || '';
    }

    modalBackdrop.classList.remove('modal-hidden');
  }

  function closeCardModal() {
    modalBackdrop.classList.add('modal-hidden');
  }

  // ===== ADD / EDIT / DELETE LOGIC =====
  function handleAdd(board, column) {
    openCardModal('add', { board, column });
  }

  function handleEdit(itemId) {
    const item = items.find(it => it.id === itemId);
    if (!item) return;
    openCardModal('edit', { item, board:item.board, column:item.column });
  }

  function handleDelete(itemId) {
    const item = items.find(it => it.id === itemId);
    if (!item) return;
    if (!confirm('Delete this item?')) return;
    items = items.filter(it => it.id !== itemId);
    saveData();
    refresh();
  }

  // submit modal form
  formEl.addEventListener('submit', (e) => {
    e.preventDefault();
    modalErrorEl.textContent = '';

    const mode = fieldMode.value;
    const board = fieldBoard.value;
    const column = fieldColumn.value;

    const title = fieldTitle.value.trim();
    const amount = parseFloat(fieldAmount.value);
    const currency = fieldCurrency.value || 'KZT';
    const paymentMethod = fieldPayment.value || 'other';
    const type = fieldType.value === 'income' ? 'income' : 'expense';
    const date = fieldDate.value;
    const comment = fieldComment.value.trim();

    if (!title) {
      modalErrorEl.textContent = 'Title is required.';
      return;
    }
    if (!amount || amount <= 0) {
      modalErrorEl.textContent = 'Amount must be positive.';
      return;
    }
    if (!date || !parseDate(date)) {
      modalErrorEl.textContent = 'Date is required.';
      return;
    }

    if (mode === 'add') {
      items.push({
        id: generateId(),
        board,
        column,
        title,
        amount,
        currency,
        paymentMethod,
        type,
        date,
        comment
      });
    } else if (mode === 'edit') {
      const id = fieldId.value;
      const item = items.find(it => it.id === id);
      if (!item) {
        modalErrorEl.textContent = 'Item not found.';
        return;
      }
      Object.assign(item, {
        title,
        amount,
        currency,
        paymentMethod,
        type,
        date,
        comment
      });
    }

    saveData();
    closeCardModal();
    refresh();
  });

  document.getElementById('modal-close-btn').addEventListener('click', closeCardModal);
  document.getElementById('modal-cancel-btn').addEventListener('click', closeCardModal);
  modalBackdrop.addEventListener('click', (e) => {
    if (e.target === modalBackdrop) closeCardModal();
  });

  // ===== DRAG & DROP =====
  function handleDragStart(e) {
    const card = e.currentTarget;
    dragItemId = card.dataset.itemId;
    card.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
  }

  function handleDragEnd(e) {
    e.currentTarget.classList.remove('dragging');
    dragItemId = null;
    document.querySelectorAll('.column-body').forEach(el => el.classList.remove('drop-target'));
  }

  function setupDragDrop() {
    document.querySelectorAll('.column-body').forEach(body => {
      body.addEventListener('dragover', e => {
        if (!dragItemId) return;
        e.preventDefault();
        body.classList.add('drop-target');
      });
      body.addEventListener('dragleave', () => {
        body.classList.remove('drop-target');
      });
      body.addEventListener('drop', e => {
        if (!dragItemId) return;
        e.preventDefault();
        body.classList.remove('drop-target');
        const item = items.find(it => it.id === dragItemId);
        if (!item) return;
        const newBoard = body.dataset.board;
        const newColumn = body.dataset.dropColumn;
        if (!newBoard || !newColumn) return;
        item.board = newBoard;
        item.column = newColumn;
        saveData();
        refresh();
      });
    });
  }

  // ===== FILTERS & TABS =====
  function setupFilters() {
    const filterSelect = document.getElementById('filter-mode');
    const customRange = document.getElementById('custom-range');
    const dateFrom = document.getElementById('date-from');
    const dateTo = document.getElementById('date-to');

    filterSelect.addEventListener('change', () => {
      filterMode = filterSelect.value;
      if (filterMode === 'custom') {
        customRange.style.display = '';
        if (!customFrom) customFrom = todayDateString();
        if (!customTo) customTo = todayDateString();
        dateFrom.value = customFrom;
        dateTo.value = customTo;
      } else {
        customRange.style.display = 'none';
      }
      refresh();
    });

    dateFrom.addEventListener('change', () => {
      customFrom = dateFrom.value || null;
      refresh();
    });
    dateTo.addEventListener('change', () => {
      customTo = dateTo.value || null;
      refresh();
    });
  }

  function setupTabs() {
    const buttons = document.querySelectorAll('.tab-btn');
    buttons.forEach(btn => {
      btn.addEventListener('click', () => {
        buttons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        activeBoard = btn.dataset.board;
        document.getElementById('board-daily').classList.toggle('hidden', activeBoard !== 'daily');
        document.getElementById('board-monthly').classList.toggle('hidden', activeBoard !== 'monthly');
      });
    });
  }

  // ===== GLOBAL CLICK HANDLERS =====
  function setupGlobalClickHandlers() {
    document.addEventListener('click', e => {
      const btn = e.target.closest('button');
      if (!btn) return;

      const action = btn.dataset.action;
      if (action === 'add') {
        const board = btn.dataset.board;
        const column = btn.dataset.column;
        handleAdd(board, column);
      } else if (action === 'edit') {
        const id = btn.dataset.itemId;
        handleEdit(id);
      } else if (action === 'delete') {
        const id = btn.dataset.itemId;
        handleDelete(id);
      }
    });
  }

  // ===== MAIN REFRESH =====
  function refresh() {
    renderBoard('daily');
    renderBoard('monthly');
    renderSummary();
    setupDragDrop();
  }

  // ===== INIT =====
  loadData();
  setupFilters();
  setupTabs();
  setupGlobalClickHandlers();
  refresh();
</script>
</body>
</html>
